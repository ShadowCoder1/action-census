<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Parkinsense Assessment</title>

    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
        }
    
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            position: relative;
            font-size: 1.25rem;
        }
        
        body.results-page {
            overflow: auto;
            height: auto;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(147, 51, 234, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

h1, h2, h3, h4, h5, h6 {
    font-size: 2.8rem; /* Makes headings larger */
    margin-bottom: 1.5rem;
}

p, li, label, input, button, textarea {
    font-size: 1.6rem;
    line-height: 1.8;
}

button, input[type="submit"], .btn {
    font-size: 1.75rem; 
    padding: 1.25rem 2.5rem;
}

@media (max-width: 480px) {
    body {
        font-size: 1rem;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-size: 1.8rem;
    }
    
    p, li, label, input, button, textarea {
        font-size: 1rem;
    }
    
    .timer-display {
        font-size: 2rem !important;
    }
    
    .taps-display {
        font-size: 2.5rem !important;
    }
    
    .hand-instruction {
        font-size: 1.2rem !important;
    }
}

        .geometric-shape {
            position: fixed;
            pointer-events: none;
            opacity: 0.03;
            z-index: 0;
        }

        .shape-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            top: -200px;
            right: -200px;
            animation: float1 20s ease-in-out infinite;
        }

        .shape-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #22c55e, #10b981);
            border-radius: 50%;
            bottom: -150px;
            left: -150px;
            animation: float2 25s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-30px, 30px) rotate(180deg); }
        }

        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (min-width: 769px) {
            #mobile-loading-overlay {
                display: none !important;
            }
        }
        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            z-index: 2;
        }

        .left-panel {
            width: 320px;
            display: flex;
            flex-direction: column;
            padding: 2.5rem 2rem;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .metrics-section {
            margin-bottom: 3rem;
        }

        .timer-display {
            font-size: 5.6rem;
            font-weight: 200;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
            line-height: 1;
        }

        .taps-counter {
            display: flex;
            align-items: baseline;
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .taps-display {
            font-size: 7rem;
            font-weight: 100;
            color: #1a1a1a;
            letter-spacing: -0.03em;
            line-height: 1;
        }

        .taps-subtitle {
            font-size: 1.3rem;
            font-weight: 400;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }


        .trial-info {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .trial-number {
            font-size: 1.1rem;
            color: #999999;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }
        
        .hand-instruction {
            font-size: 2.8rem;
            color: #1a1a1a;
            font-weight: 300;
            letter-spacing: -0.02em;
        }

        
        .instructions {
            background: rgba(247, 247, 247, 0.5);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
            max-height: none;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
        }

        .instructions h3 {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .instruction-item {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
            font-size: 1.2rem;
            font-weight: 400;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .instruction-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 4px;
            height: 4px;
            background: #22c55e;
            border-radius: 50%;
        }

        .right-panel {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        video#inputVideo {
            transform: scaleX(-1);
        }

        canvas#outputCanvas {
            transform: scaleX(-1);
        }

        /* Hand positioning guide */
        .hand-guide-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }
        
        .position-status {
            font-size: 1.5rem;
            font-weight: 500;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 1.25rem 2.5rem;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .position-status.ready {
            background: rgba(34, 197, 94, 0.9);
            white-space: normal !important;     
            text-align: center;               
            line-height: 1.4;                  
            font-size: 1.2rem;                
            padding: 1rem 1.5rem;                
            max-width: 90%;                 
            margin: 0 auto;                    
        }
        

        .position-status.warning {
            background: rgba(245, 158, 11, 0.9);
        }

        .position-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        #hand-outline {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 420px;
            height: auto;
            opacity: 0.3;
            pointer-events: none;
            z-index: 80;
            transition: all 0.3s ease;
            filter: invert(1);
        }

        .hand-outline-ready {
            opacity: 0.6 !important;
            filter: invert(1) drop-shadow(0 0 20px #22c55e);
        }

        .hand-outline-not-ready {
            opacity: 0.4 !important;
            filter: invert(1) drop-shadow(0 0 20px #ef4444);
        }

        .center-timer {
          position: absolute;
          top: 40%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 16rem;
          font-weight: 200;
          color: rgba(255,255,255,0.6);
          text-shadow: 0 0 25px rgba(59, 130, 246, 0.7);
          z-index: 210;
          letter-spacing: -0.02em;
          line-height: 1;
          display: none;
        }
        
        .center-timer::after {
          content: attr(data-taps) " taps";
          position: absolute;
          top: 120%;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.5em;
          font-weight: 400;
          color: rgba(34, 197, 94, 0.9);
          text-shadow: 0 0 25px rgba(34, 197, 94, 0.8), 0 0 50px rgba(34, 197, 94, 0.4);
          white-space: nowrap;
          background: rgba(0, 0, 0, 0.3);
          padding: 0.2em 0.6em;
          border-radius: 0.3em;
          backdrop-filter: blur(10px);
        }
        @media (max-width: 768px) {
          .center-timer { font-size: 10rem; }
        }
        
        

        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
        }

        .trial-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .trial-overlay-content {
            max-width: 600px;
            text-align: center;
        }

        .trial-overlay-title {
            font-size: 4.9rem;
            font-weight: 200;
            margin-bottom: 2rem;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }

        .trial-overlay-instruction {
            font-size: 2rem;
            color: #1a1a1a;
            margin: 2rem 0;
            font-weight: 400;
        }
        .trial-overlay-instruction strong {
            color: #3b82f6;
            font-weight: 600;
        }

        .trial-overlay-footer {
            font-size: 1.3rem;
            color: #666666;
            font-weight: 400;
            margin-top: 3rem;
            padding: 1.25rem 2.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 50px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        @media (max-width: 768px) {
            .trial-overlay-footer {
                cursor: pointer;
                background: rgba(59, 130, 246, 0.1);
                border: 2px solid rgba(59, 130, 246, 0.3);
                color: #3b82f6;
                font-weight: 500;
            }
            
            .trial-overlay-footer:active {
                background: rgba(59, 130, 246, 0.2);
                transform: scale(0.98);
            }
        }

        .feedback-panel {
            position: absolute;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(245, 158, 11, 0.9);
            padding: 1rem 2rem;
            border-radius: 50px;
            color: white;
            text-align: center;
            z-index: 100;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .feedback-message {
            font-size: 1.3rem;
            font-weight: 500;
        }

        .final-results {
            max-width: 1200px;
            margin: 0 auto;
            padding: 4rem 2rem;
            position: relative;
            z-index: 2;
            background: #fafafa;
            min-height: 100vh;
        }

        .results-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 1024px) {
            .left-panel {
                width: 280px;
                padding: 2rem 1.25rem;
            }
            
            .timer-display {
                font-size: 5rem;
            }
            
            .taps-display {
                font-size: 6rem;
            }
            
            .hand-instruction {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column !important;
                height: 100vh !important;
            }
            
            .left-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding-bottom: calc(0.75rem + var(--safe-area-inset-bottom));
                padding-left: calc(0.75rem + var(--safe-area-inset-left));
                padding-right: calc(0.75rem + var(--safe-area-inset-right));
                width: 100%;
                height: auto;
                min-height: 140px;
                max-height: 200px;
                padding: 0.75rem;
                border-right: none !important;
                border-left: none !important;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                border-bottom: none;
                flex-shrink: 0;
                z-index: 100;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
            }
            
            .right-panel {
                flex: 1;
                height: 100vh;
                min-height: 0;
            }
            
            .video-container {
                height: 100%;
                position: relative;
            }
            
            video, canvas {
                height: 100% !important;
                width: 100% !important;
                object-fit: cover !important;
            }
            
             .metrics-section {
                display: none;
             }
            
            .timer-display {
                font-size: 2.5rem;
                line-height: 1;
            }
            
            .taps-counter {
                margin-bottom: 0;
                gap: 0.5rem;
            }
            
            .taps-display {
                font-size: 3rem;
                line-height: 1;
            }
            
            .taps-subtitle {
                font-size: 0.9rem;
            }
            
            .trial-info {
                margin-bottom: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .trial-number {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
            
            .hand-instruction {
                font-size: 1.4rem;
                line-height: 1.2;
            }
            
            .instructions {
                display: block !important;
                max-height: 100px;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .instruction-item {
                font-size: 1rem !important;
                margin-bottom: 0.4rem;
                line-height: 1.3;
            }
            
            .trial-overlay-title {
                font-size: 2.5rem;
            }
            
            .trial-overlay-instruction {
                font-size: 1.4rem;
            }
       }

                /* iPhone SE and small devices - prevent instruction cutoff */
        @media (max-width: 430px) and (max-height: 700px) {
            .trial-overlay-title {
                font-size: 1.6rem;
                margin-bottom: 0.8rem;
            }
        
            .trial-overlay-instruction {
                font-size: 1rem;
                margin: 0.8rem 0;
                line-height: 1.4;
            }
        
            .trial-overlay-content {
                padding: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
        
            .trial-overlay-footer {
                font-size: 0.95rem !important;
                padding: 0.85rem 1.4rem !important;
                margin-top: 1.2rem !important;
            }
        
            .instructions {
                max-height: 140px;
                padding: 0.6rem;
                font-size: 0.8rem;
            }
        
            .instruction-item {
                font-size: 0.8rem !important;
                margin-bottom: 0.3rem;
                line-height: 1.25;
                padding-left: 1rem;
            }
        }

        /* iPhone SE specific fixes */
        @media (max-width: 568px) and (max-height: 667px) {
            .trial-overlay-footer {
                position: fixed !important;
                bottom: 10px !important;
                left: 10px !important;
                right: 10px !important;
                z-index: 10001 !important;
                margin: 0 !important;
                padding: 1rem !important;
                font-size: 1.1rem !important;
                min-height: 44px !important;
                border-radius: 8px !important;
                background: #3b82f6 !important;
                color: white !important;
                border: none !important;
            }
            
            #questionnaire-overlay button[type="submit"] {
                position: fixed !important;
                bottom: 10px !important;
                left: 10px !important;
                right: 10px !important;
                z-index: 10002 !important;
                min-height: 50px !important;
                margin: 0 !important;
            }
            
            .final-results {
                padding-bottom: 80px !important;
            }
            
            .final-results button {
                min-height: 50px !important;
                margin: 0.5rem 0 !important;
                width: 100% !important;
            }
            
            /* Ensure viewport height accounts for safe areas */
            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }
        }

        .layout-right-hand .main-container {
            flex-direction: row-reverse; 
        }
        
        .layout-right-hand .left-panel {
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            border-right: none;
        }
        
        .layout-left-hand .main-container {
            flex-direction: row;
        }
        
        .layout-left-hand .left-panel {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            border-left: none;
        }

        @media (max-width: 768px) {
            .layout-right-hand .main-container,
            .layout-left-hand .main-container {
                flex-direction: column !important;
            }
            
            .layout-right-hand .left-panel,
            .layout-left-hand .left-panel {
                border-left: none !important;
                border-right: none !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
            }
            
            .layout-left-hand #hand-outline,
            .layout-right-hand #hand-outline {
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
            }
            
            .layout-left-hand .hand-guide-overlay,
            .layout-right-hand .hand-guide-overlay {
                left: 50% !important;
            }
        }
        
        .layout-left-hand #hand-outline {
            left: 30% !important;
            transform: translate(-50%, -50%) scaleX(-1);
        }
        
        
        .layout-right-hand #hand-outline {
            left: 70% !important;
            transform: translate(-50%, -50%);
        }
        
        .layout-left-hand .hand-guide-overlay {
            left: 29% !important;
        }
        
        .layout-right-hand .hand-guide-overlay {
            left: 72% !important;
        }

.likert-scale {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.3rem;
        }

        .likert-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.2rem;
            flex: 1;
        }

        .likert-option input[type="radio"] {
            margin-bottom: 0.1rem;
            transform: scale(1.1);
            cursor: pointer;
        }

        .likert-option label {
            font-size: 0.75rem;
            color: #666666;
            text-align: center;
            cursor: pointer;
            line-height: 1.1;
        }

        @media (max-width: 768px) {
            .likert-scale {
                gap: 0.1rem;
            }
            
            .likert-option {
                padding: 0.1rem;
            }
            
            .likert-option label {
                font-size: 0.7rem;
            }
            
            div[style*="grid-template-columns: 1fr 1fr"],
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
        @media (max-width: 768px) {
            .hand-guide-overlay {
                top: 50% !important;
                left: 50% !important;
            }
            .position-status {
                position: relative;
                z-index: 150;
                pointer-events: auto;
                display: block !important;
            }
            
            .position-status {
                font-size: 1rem;
                padding: 0.75rem 1.5rem;
                white-space: normal;
                max-width: 280px;
                line-height: 1.3;
            }
        
            #hand-outline {
                width: clamp(280px, 65vw, 420px) !important;


                top: 35% !important;
                left: 50% !important;
            }
        

            .layout-left-hand #hand-outline {
                transform: translate(-40%, -50%) scaleX(-1) !important;
            }



            .layout-right-hand #hand-outline {
                transform: translate(-60%, -50%) !important;
            }


            
            .feedback-panel {
                bottom: 1rem;
                padding: 0.5rem 1rem;
            }
            
            .feedback-message {
                font-size: 1rem;
            }
            
            .countdown {
                font-size: 8rem;
            }
        }

        @media (max-width: 768px) {
            #questionnaire-overlay {
                padding: 0 !important;
            }
            
            #questionnaire-overlay > div {
                width: 100vw !important;
                height: 100vh !important;
                max-width: none !important;
                max-height: none !important;
                border-radius: 0 !important;
                padding: 1rem !important;
                padding-bottom: 2rem !important;
                box-sizing: border-box;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Ensure all form elements are properly sized for small screens */
            .mobile-question-group {
                background: rgba(0, 0, 0, 0.02);
                border-radius: 8px;
                padding: 0.75rem;
                margin-bottom: 1rem;
                border: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            /* Make buttons more accessible on small screens */
            button[type="submit"] {
                min-height: 44px !important;
                padding: 1rem 1.5rem !important;
                font-size: 1.1rem !important;
                margin-top: 1rem !important;
            }
            
            input, textarea {
                min-height: 44px !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
        
            .mobile-question-group {
                background: rgba(0, 0, 0, 0.02);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1.5rem;
                border: 1px solid rgba(0, 0, 0, 0.05);
            }
        
            .mobile-likert-container {
                background: white;
                border-radius: 8px;
                padding: 0.75rem;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }
        
            .mobile-likert-scale {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.1rem;
            }
        
            .mobile-likert-scale .likert-option {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0.25rem;
                cursor: pointer;
            }
        
            .mobile-likert-scale .likert-option input[type="radio"] {
                transform: scale(1.3);
                margin-bottom: 0.25rem;
            }
        
            .mobile-likert-scale .likert-option span {
                font-size: 0.8rem;
                color: #666;
                font-weight: 500;
            }
        
            .final-results {
                padding: 2rem 1rem !important;
                min-height: 100vh;
            }
        
            .final-results > div {
                padding: 2rem 1rem !important;
                text-align: center;
            }
        
            .final-results p {
                font-size: 1.4rem !important;
                line-height: 1.4 !important;
                margin-bottom: 2rem !important;
            }
        
            .final-results p strong {
                font-size: 1.6rem !important;
                color: #22c55e;
            }
        
            .final-results .mobile-button-container {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }
        
            .final-results button {
                width: 100% !important;
                padding: 1.25rem 2rem !important;
                font-size: 1.2rem !important;
                border-radius: 12px !important;
                margin: 0 !important;
            }
        
            .mobile-prolific-code {
                background: rgba(34, 197, 94, 0.1) !important;
                border: 2px solid #22c55e !important;
                border-radius: 12px !important;
                padding: 1.5rem !important;
                margin: 2rem 0 !important;
                text-align: center;
            }
        
            .mobile-prolific-code p:first-child {
                font-size: 1.2rem !important;
                margin-bottom: 0.75rem !important;
            }
        
            .mobile-prolific-code p:nth-child(2) {
                font-size: 2rem !important;
                font-weight: 700 !important;
                letter-spacing: 0.1em;
                color: #22c55e !important;
                font-family: 'Courier New', monospace !important;
                margin-bottom: 0.75rem !important;
            }
        
            .mobile-prolific-code p:last-child {
                font-size: 1rem !important;
                color: #666 !important;
                margin: 0 !important;
            }
        }
                
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCIijYBeCcyl8Mt414nueAgIId8PfWaW5M",
        authDomain: "pdstudy-99397.firebaseapp.com",
        projectId: "pdstudy-99397",
        storageBucket: "pdstudy-99397.firebasestorage.app",
        messagingSenderId: "235927780090",
        appId: "1:235927780090:web:348a8c85c130371686a743",
        measurementId: "G-Y116J49LYT"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let participantID = sessionStorage.getItem('prolificID');
    if (!participantID) {
        participantID = `anon_${Date.now()}`;
        sessionStorage.setItem('prolificID', participantID);
    }
    
        // Collect device information
    const deviceInfo = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        vendor: navigator.vendor || 'Unknown',
        screenWidth: window.screen.width,
        screenHeight: window.screen.height,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        devicePixelRatio: window.devicePixelRatio,
        touchPoints: navigator.maxTouchPoints || 0,
        timestamp: new Date().toISOString()
    };
    
    // Save device info to Firebase
    db.collection("Participants")
        .doc(participantID)
        .collection("DeviceInfo")
        .doc("device")
        .set(deviceInfo)
        .then(() => console.log("✅ Device info saved"))
        .catch(err => console.error("❌ Error saving device info:", err));
    </script>

</head>
<body>

    <!-- Mobile Loading Overlay -->
    <div id="mobile-loading-overlay" style="display: none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); z-index: 99999; backdrop-filter: blur(10px);">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 2rem;">
                <div style="width: 60px; height: 60px; margin: 0 auto 2rem; position: relative;">
                    <div class="loading-spinner" style="width: 100%; height: 100%; border: 3px solid rgba(59, 130, 246, 0.2); border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
                <h3 style="font-size: 1.5rem; color: #1a1a1a; margin-bottom: 1rem; font-weight: 500;">Starting Camera</h3>
                <p id="loading-status" style="font-size: 1rem; color: #666666; margin-bottom: 1.5rem;">Initializing hand tracking...</p>
                <div style="width: 100%; max-width: 300px; height: 4px; background: rgba(59, 130, 246, 0.2); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                    <div id="loading-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 2px; transition: width 0.3s ease;"></div>
                </div>
                <p style="font-size: 0.9rem; color: #999999; margin-top: 1.5rem; max-width: 280px;">Make sure your camera permissions are enabled and you're in good lighting</p>
            </div>
        </div>
    </div>
    <div class="geometric-shape shape-1"></div>
    <div class="geometric-shape shape-2"></div>

    <div id="trial-instructions-overlay" class="trial-overlay" style="display: none;">
        <div class="trial-overlay-content">
            <div id="trial-instructions-text" class="trial-overlay-title">
           
            </div>
            <div class="trial-overlay-instruction">
               Tap your fingers to start—go as <strong style="color: #ef4444;">FAST</strong> as you can!
                 
            </div>
            <p class="trial-overlay-footer" id="begin-instruction">Press SPACEBAR to begin</p>
        </div>
    </div>
  
    <div id="questionnaire-overlay" class="trial-overlay" style="display: none;">
        <div style="max-width: 1200px; width: 95%; max-height: 95vh; overflow-y: auto; background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="font-size: 2.4rem; font-weight: 300; color: #1a1a1a; margin-bottom: 0.5rem; letter-spacing: -0.02em;">Quick Questions</h2>
                <p style="font-size: 1.1rem; color: #666666; font-weight: 400;">Please answer these brief questions about your experience</p>
            </div>

            <form id="questionnaire-form" style="text-align: left;">
            
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
                    <p style="font-size: 1rem; color: #1a1a1a; margin: 0;"><strong>Rating Scale:</strong> 1 = Very Low/Poor, 7 = Very High/Excellent</p>
                </div>

                <!-- Experience Questions Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Video game experience:</label>
                        <div class="likert-scale" id="videogame-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Musical experience:</label>
                        <div class="likert-scale" id="musical-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Sports experience:</label>
                        <div class="likert-scale" id="sports-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Caffeine intake today:</label>
                        <div class="likert-scale" id="caffeine-scale"></div>
                    </div>
                </div>

                <!-- Mood and Performance Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Current mood:</label>
                        <div class="likert-scale" id="mood-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Task motivation:</label>
                        <div class="likert-scale" id="motivated-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Task distraction:</label>
                        <div class="likert-scale" id="distracted-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Expected performance vs. others:</label>
                        <div class="likert-scale" id="performance-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Persistence when tasks get frustrating:</label>
                        <div class="likert-scale" id="persistence-scale"></div>
                    </div>
                    
                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Attention span in general:</label>
                        <div class="likert-scale" id="attention-scale"></div>
                    </div>
                    
                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Enjoyment of competition:</label>
                        <div class="likert-scale" id="competition-scale"></div>
                    </div>

                    <div class="question-group">
                        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Internet connection speed during task:</label>
                        <div class="likert-scale" id="internet-scale"></div>
                    </div>
                </div>

                <!-- Neurological Question -->
                <div class="question-group" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Do you have any known neurological conditions?</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="neurological" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="neurological" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                                <!-- Hand Pain Question -->
                <div class="question-group" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Do you currently have hand-related pain that affects your performance on tasks like this?</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="handPain" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="handPain" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                <!-- Injury/Disease History Question -->
                <div class="question-group" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">History of injury/disease affecting hand/arm movement:</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="handInjuryHistory" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: 1.1rem; cursor: pointer;">
                            <input type="radio" name="handInjuryHistory" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                <!-- Task Issues Checkboxes -->
<div class="question-group" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
    <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 1rem; display: block;">Did you experience any of these issues during the task? (Check all that apply)</label>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer;">
            <input type="checkbox" name="issue_tapCounter" value="yes" style="margin-right: 0.75rem; transform: scale(1.2);">
            The tap counter didn't accurately count my taps
        </label>
        <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer;">
            <input type="checkbox" name="issue_internet" value="yes" style="margin-right: 0.75rem; transform: scale(1.2);">
            I experienced internet connectivity issues
        </label>
        <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer;">
            <input type="checkbox" name="issue_laggy" value="yes" style="margin-right: 0.75rem; transform: scale(1.2);">
            The camera feed was laggy or slow
        </label>
        <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer;">
            <input type="checkbox" name="issue_handView" value="yes" style="margin-right: 0.75rem; transform: scale(1.2);">
            I had trouble keeping my hand in view
        </label>
        <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer;">
            <input type="checkbox" name="issue_other" value="yes" style="margin-right: 0.75rem; transform: scale(1.2);">
            Other issues (please describe below)
        </label>
    </div>
</div>

<!-- Demographics Questions -->

<!-- Demographics Questions -->
<div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1.5rem;">
    <div style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
        <p style="font-size: 0.95rem; color: #1a1a1a; margin: 0;"><strong>Why we ask:</strong> Understanding participants' income levels and geographic location helps us examine how economic factors may influence physical ability. Your response helps ensure our findings reflect the experiences of people from diverse financial and geographical backgrounds.</p>
    </div>
    
    <div class="question-group" style="margin-bottom: 1.5rem;">
        <label style="font-size: 1.1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 1rem; display: block;">What is your total annual household income before taxes? (Please select the range that best represents your income.)</label>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="less-than-20k" required style="margin-right: 0.75rem; transform: scale(1.2);">
                "Less than $20,000"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="20k-39k" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$20,000 - $39,999"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="40k-59k" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$40,000 - $59,999"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="60k-79k" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$60,000 - $79,999"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="80k-99k" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$80,000 - $99,999"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="100k-149k" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$100,000 - $149,999"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="150k-plus" style="margin-right: 0.75rem; transform: scale(1.2);">
                "$150,000 or more"
            </label>
            <label style="display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 0.3rem 0;">
                <input type="radio" name="income" value="prefer-not-to-answer" style="margin-right: 0.75rem; transform: scale(1.2);">
                "Prefer not to answer"
            </label>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
        <div class="question-group">
            <label style="font-size: 1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Zip/Postal code:</label>
            <input type="text" name="zipcode" placeholder="Your zip code" required style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 2px solid #e5e7eb; border-radius: 6px;">
        </div>

        <div style="display: flex; align-items: end;">
            <button type="submit" style="background-color: #000000; color: white; border: none; padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: 500; border-radius: 40px; cursor: pointer; transition: all 0.2s ease; font-family: 'Inter', sans-serif; width: 100%;">
                Continue to Results
            </button>
        </div>
    </div>

                    <div class="question-group">
                        <label style="font-size: 1rem; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Additional feedback or comments:</label>
                        <textarea name="feedback" rows="2" placeholder="Any additional thoughts about the test..." style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-family: 'Inter', sans-serif;"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="page-webcam" style="display:none;">
        <div class="main-container" id="main-container">
            <div class="left-panel">
                <div class="metrics-section">
                    

                </div>
                
                <div class="trial-info">
                    <div class="trial-number" id="trial-number">Trial 1 of 6</div>
                    <div class="hand-instruction" id="hand-instruction">Right Hand</div>
                </div>
                
                <div class="instructions">
                    <h3>Guidelines</h3>
                    <div class="instruction-item" style="color: #ef4444;">Tap your fingers to start—go as fast as you can!</div>
                    <div class="instruction-item">Open fingers wide between taps</div>
                    <div class="instruction-item">Palm facing camera</div>
                    <div class="instruction-item">Make large, clear tapping movements</div>
                    <div class="instruction-item">Keep a steady rhythm</div>
                </div>
            </div>

            <div class="right-panel">
                <div class="video-container">
                    <video id="inputVideo" autoplay playsinline></video>
                    <canvas id="outputCanvas"></canvas>
                    
                    <!-- Hand outline guide -->
                    <img id="hand-outline" src="https://raw.githubusercontent.com/ShadowCoder1/pd-video-analyzer/main/download.png" alt="Hand Outline Guide">


                    <!-- Hand positioning guide -->
                    <div id="hand-guide-overlay" class="hand-guide-overlay">
                        <div id="position-status" class="position-status">
                            Position hand in view
                        </div>
                    </div>

                    <div id="tapWidthFeedback" class="feedback-panel">
                        <div id="tapWidthMessage" class="feedback-message">Open fingers wider</div>
                    </div>

                    <div id="countdown" class="countdown" style="display: none;"></div>
                    <div id="center-timer" class="center-timer">00:10</div>


                </div>
            </div>
        </div>
    </div>

    <div id="finalResults" class="final-results" style="display: none;">

    </div>

    <script>
        let camera, hands, canvasCtx, recording = false;
        let startTime, handDetected = false;
        let distanceChart, velocityChart;
        let recordingDuration = 10000;


        let countdownInterval;
        let frameCount = 0;
        let mainTimerInterval;
        
        let inactivityInterval = null;
        let stopTimeoutId = null;
        
        let currentTrialToken = 0;
        let activeTrialToken = 0;
        
        let iPadLastProcessedFrame = 0;
        let fpsHistory = [];
        let lastFpsCalcTime = 0;
        let frameTimestamps = [];
  
        let readyToStart = false;
        let preStartTapCount = 0;
        let lastPreStartTapTime = 0;
        
        let lastHandSeenTime = 0;
   
        const MAX_ALLOWED_HAND_LOSS = 3000; 
        const MAX_ALLOWED_NO_TAPS = 5000;

        let distanceSignal = [];
        let timeSignal = [];
        let smoothedSignal = [];
        let velocitySignal = [];
        let peakIndices = [];
        let landmarkSeries = [];
        let frameData = [];

        // Reset position checking state
        window.handPositionCorrect = false;
        frameCount = 0;
        window.tapFeedbackTimer = 0;

        let currentDetectedHand = null;

        const VIDEO_MIRRORED = true;
        
        const HAND_LABEL_WINDOW = 7;
        let handLabelBuffer = [];
        function pushHandLabel(lbl) {
          if (!lbl) return;
          handLabelBuffer.push(lbl);
          if (handLabelBuffer.length > HAND_LABEL_WINDOW) handLabelBuffer.shift();
        }
        function getStableHandLabel() {
          if (handLabelBuffer.length === 0) return null;
          const counts = {};
          for (const l of handLabelBuffer) counts[l] = (counts[l] ?? 0) + 1;
          // mode
          return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
        }


        function isCorrectHandDetectedForCurrentTrial() {
            const requiredHand = trialConditions[trialIndex % trialConditions.length].hand.toLowerCase();
            if (!currentDetectedHand) return false;
            return currentDetectedHand.toLowerCase() === requiredHand;
        }

        let tapEvents = [];
        let lastPeakTime = 0;
        
        const SAMPLE_RATE = 30;
        
        const startWithLeft = Math.random() < 0.5;
        const trialConditions = startWithLeft ? [
            { hand: 'left' },
            { hand: 'right' },
            { hand: 'left' },
            { hand: 'right' },
            { hand: 'left' },
            { hand: 'right' }
        ] : [
            { hand: 'right' },
            { hand: 'left' },
            { hand: 'right' },
            { hand: 'left' },
            { hand: 'right' },
            { hand: 'left' }
        ];
        let trialIndex = 0;
        let totalTrials = trialConditions.length;

        let allTrialResults = []
        let totalTapsAcrossAllTrials = 0;
        function createLikertScale(name, leftLabel, rightLabel) {
                    let html = '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                    html += `<span style="font-size: 0.8rem; color: #666666; min-width: 60px; text-align: right;">${leftLabel}</span>`;
                    
                    for (let i = 1; i <= 7; i++) {
                        html += `
                            <label class="likert-option">
                                <input type="radio" name="${name}" value="${i}" required>
                                <span style="font-size: 0.75rem; color: #666666;">${i}</span>
                            </label>
                        `;
                    }
                    
                    html += `<span style="font-size: 0.8rem; color: #666666; min-width: 60px; text-align: left;">${rightLabel}</span>`;
                    html += '</div>';
                    return html;
        }

        function generateProlificCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function isIPadOrTablet() {
            const isIPad = /iPad/.test(navigator.userAgent) || 
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            const isLargeTablet = window.innerWidth > 768 && window.innerWidth <= 1024 && 'ontouchstart' in window;
            
            return isIPad || isLargeTablet;
        }

        function isIPad() {
            return /iPad/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
function showQuestionnaire() {
    document.getElementById('page-webcam').style.display = 'none';
    
    const questionnaireHTML = `
        <div style="${window.innerWidth <= 768 ? 'width: 100vw; height: 100vh; overflow-y: auto; background: white; padding: 1rem; box-sizing: border-box;' : 'max-width: 1200px; width: 95%; max-height: 95vh; overflow-y: auto; background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1);'}">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="font-size: ${window.innerWidth <= 768 ? 'clamp(1.8rem, 5vw, 2.2rem)' : '2.4rem'}; font-weight: 300; color: #1a1a1a; margin-bottom: 0.5rem; letter-spacing: -0.02em;">Quick Questions</h2>
                <p style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; color: #666666; font-weight: 400;">Please answer these brief questions about your experience</p>
            </div>

            <form id="questionnaire-form" style="text-align: left;">
                <!-- Likert Scale Explanation -->
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
                    <p style="font-size: ${window.innerWidth <= 768 ? 'clamp(0.9rem, 2.5vw, 1rem)' : '1rem'}; color: #1a1a1a; margin: 0;"><strong>Rating Scale:</strong> 1 = Very Low/Poor, 7 = Very High/Excellent</p>
                </div>

                <!-- Experience Questions -->
                <div style="${window.innerWidth <= 768 ? 'margin-bottom: 2rem;' : 'display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;'}">
                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Video game experience:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="videogame-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="videogame-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Musical experience:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="musical-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="musical-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Sports experience:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="sports-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="sports-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Caffeine intake today:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="caffeine-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="caffeine-scale"></div>
                        </div>
                    </div>
                </div>

                <!-- Mood and Performance Questions -->
                <div style="${window.innerWidth <= 768 ? 'margin-bottom: 2rem;' : 'display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;'}">
                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Current mood:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="mood-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="mood-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Task motivation:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="motivated-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="motivated-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Task distraction:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="distracted-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="distracted-scale"></div>
                        </div>
                    </div>


                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Persistence when tasks get frustrating:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="persistence-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="persistence-scale"></div>
                        </div>
                    </div>
                    
                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Attention span in general:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="attention-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="attention-scale"></div>
                        </div>
                    </div>
                    
<div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Enjoyment of competition:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="competition-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="competition-scale"></div>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Internet connection speed during task:</label>
                        <div class="${window.innerWidth <= 768 ? 'mobile-likert-container' : 'likert-scale'}" id="internet-scale-container">
                            <div class="${window.innerWidth <= 768 ? 'mobile-likert-scale' : 'likert-scale'}" id="internet-scale"></div>
                        </div>
                    </div>
                </div>


                <!-- Neurological Question -->
                <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Do you have any known neurological conditions?</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="neurological" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="neurological" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                <!-- Hand Pain Question -->
                <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Do you currently have hand-related pain that affects your performance on tasks like this?</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="handPain" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="handPain" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                <!-- Injury/Disease History Question -->
                <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}" style="margin-bottom: 1.5rem; background: rgba(0,0,0,0.02); padding: 1rem; border-radius: 8px;">
                    <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">History of injury/disease affecting hand/arm movement:</label>
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="handInjuryHistory" value="no" required style="margin-right: 0.5rem; transform: scale(1.2);">
                            No
                        </label>
                        <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; cursor: pointer;">
                            <input type="radio" name="handInjuryHistory" value="yes" style="margin-right: 0.5rem; transform: scale(1.2);">
                            Yes
                        </label>
                    </div>
                </div>

                <!-- Demographics Questions -->
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
                        <p style="font-size: ${window.innerWidth <= 768 ? 'clamp(0.9rem, 2.5vw, 0.95rem)' : '0.95rem'}; color: #1a1a1a; margin: 0;"><strong>Why we ask:</strong> Understanding participants' income levels and geographic location helps us examine how economic factors may influence physical ability. Your response helps ensure our findings reflect the experiences of people from diverse financial and geographical backgrounds.</p>
                    </div>
                    
                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}" style="margin-bottom: 1.5rem;">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1.1rem)' : '1.1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 1rem; display: block;">What is your total annual household income before taxes? (Please select the range that best represents your income.)</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="less-than-20k" required style="margin-right: 0.75rem; transform: scale(1.2);">
                                "Less than $20,000"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="20k-39k" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$20,000 - $39,999"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="40k-59k" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$40,000 - $59,999"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="60k-79k" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$60,000 - $79,999"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="80k-99k" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$80,000 - $99,999"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="100k-149k" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$100,000 - $149,999"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="150k-plus" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "$150,000 or more"
                            </label>
                            <label style="display: flex; align-items: center; font-size: ${window.innerWidth <= 768 ? 'clamp(0.95rem, 2.8vw, 1rem)' : '1rem'}; cursor: pointer; padding: 0.3rem 0;">
                                <input type="radio" name="income" value="prefer-not-to-answer" style="margin-right: 0.75rem; transform: scale(1.2);">
                                "Prefer not to answer"
                            </label>
                        </div>
                    </div>

                    <div style="${window.innerWidth <= 768 ? 'margin-bottom: 2rem;' : 'display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;'}">
                        <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                            <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1rem)' : '1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Zip/Postal code:</label>
                            <input type="text" name="zipcode" placeholder="Your zip code" required style="width: 100%; padding: 0.5rem; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1rem)' : '1rem'}; border: 2px solid #e5e7eb; border-radius: 6px;">
                        </div>

                        <div style="${window.innerWidth <= 768 ? 'margin-top: 1rem;' : 'display: flex; align-items: end;'}">
                            <button type="submit" style="background-color: #000000; color: white; border: none; padding: 0.75rem 2rem; font-size: ${window.innerWidth <= 768 ? 'clamp(1.1rem, 3.5vw, 1.3rem)' : '1.1rem'}; font-weight: 500; border-radius: 40px; cursor: pointer; transition: all 0.2s ease; font-family: 'Inter', sans-serif; width: 100%;">
                                Continue to Results
                            </button>
                        </div>
                    </div>

                    <div class="${window.innerWidth <= 768 ? 'mobile-question-group' : 'question-group'}">
                        <label style="font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1rem)' : '1rem'}; font-weight: 500; color: #1a1a1a; margin-bottom: 0.5rem; display: block;">Additional feedback or comments:</label>
                        <textarea name="feedback" rows="2" placeholder="Any additional thoughts about the test..." style="width: 100%; padding: 0.5rem; font-size: ${window.innerWidth <= 768 ? 'clamp(1rem, 3vw, 1rem)' : '1rem'}; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; font-family: 'Inter', sans-serif;"></textarea>
                    </div>
                </div>
            </form>
        </div>
    `;
    
const questionnaireOverlay = document.getElementById('questionnaire-overlay');
    if (!questionnaireOverlay) {
        console.error("❌ questionnaire-overlay element not found!");
        showFinalResults();
        return;
    }
    questionnaireOverlay.innerHTML = questionnaireHTML;
    
    function createMobileLikertScale(name, leftLabel, rightLabel) {
        if (window.innerWidth <= 768 || isIPadOrTablet()) {
            let html = '';
            for (let i = 1; i <= 7; i++) {
                html += `
                    <label class="likert-option">
                        <input type="radio" name="${name}" value="${i}" required>
                        <span>${i}</span>
                    </label>
                `;
            }
            return html;
        } else {
            let html = '<div style="display: flex; align-items: center; gap: 0.5rem;">';
            html += `<span style="font-size: 0.8rem; color: #666666; min-width: 60px; text-align: right;">${leftLabel}</span>`;
            
            for (let i = 1; i <= 7; i++) {
                html += `
                    <label class="likert-option">
                        <input type="radio" name="${name}" value="${i}" required>
                        <span style="font-size: 0.75rem; color: #666666;">${i}</span>
                    </label>
                `;
            }
            
            html += `<span style="font-size: 0.8rem; color: #666666; min-width: 60px; text-align: left;">${rightLabel}</span>`;
            html += '</div>';
            return html;
        }
    }
    
    questionnaireOverlay.style.display = 'flex';
        
    // Populate scales AFTER HTML is in the DOM
    setTimeout(() => {
        document.getElementById('videogame-scale').innerHTML = createMobileLikertScale('videogame', 'Very Low', 'Very High');
        document.getElementById('musical-scale').innerHTML = createMobileLikertScale('musical', 'Very Low', 'Very High');
        document.getElementById('sports-scale').innerHTML = createMobileLikertScale('sports', 'Very Low', 'Very High');
        document.getElementById('caffeine-scale').innerHTML = createMobileLikertScale('caffeine', 'None', 'Very High');
        document.getElementById('mood-scale').innerHTML = createMobileLikertScale('mood', 'Very Poor', 'Excellent');
        document.getElementById('motivated-scale').innerHTML = createMobileLikertScale('motivated', 'Not at all', 'Extremely');
        document.getElementById('distracted-scale').innerHTML = createMobileLikertScale('distracted', 'Not at all', 'Extremely');
        document.getElementById('persistence-scale').innerHTML = createMobileLikertScale('persistence', 'Give up quickly', 'Push through');
        document.getElementById('attention-scale').innerHTML = createMobileLikertScale('attention', 'Very short', 'Very long');
        document.getElementById('competition-scale').innerHTML = createMobileLikertScale('competition', 'Not at all', 'Very much');
        document.getElementById('internet-scale').innerHTML = createMobileLikertScale('internet', 'Very Poor', 'Excellent');
    }, 0);
      
document.getElementById('questionnaire-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const responses = {};
    
    for (let [key, value] of formData.entries()) {
        responses[key] = value;
    }
    
    console.log("📋 Questionnaire responses to save:", responses);
    
   

    const expectedFields = [
    'videogame', 'musical', 'sports', 'caffeine', 
    'mood', 'motivated', 'distracted',
    'neurological', 'handPain', 'handInjuryHistory', 'persistence', 'attention', 'competition', 'internet', 'income', 'zipcode'
    ];
    
    const missingFields = expectedFields.filter(field => !responses[field]);
    if (missingFields.length > 0) {
        console.warn("⚠️ Missing required fields:", missingFields);
        alert(`Please complete all required fields: ${missingFields.join(', ')}`);
        return;
    }

    const questionnaireData = {
        experienceRatings: {
            videogameExperience: parseInt(responses.videogame),
            musicalExperience: parseInt(responses.musical),
            sportsExperience: parseInt(responses.sports),
            caffeineIntakeToday: parseInt(responses.caffeine)
        },
        
        moodPerformanceRatings: {
            currentMood: parseInt(responses.mood),
            taskMotivation: parseInt(responses.motivated),
            taskDistraction: parseInt(responses.distracted),
            internetConnectionSpeed: parseInt(responses.internet),
            persistenceWhenFrustrated: parseInt(responses.persistence),
            attentionSpanGeneral: parseInt(responses.attention),
            enjoymentOfCompetition: parseInt(responses.competition)
        },
        
        taskIssues: {
            inaccurateTapCounter: responses.issue_tapCounter === 'yes',
            internetConnectivityIssues: responses.issue_internet === 'yes',
            cameraFeedLaggy: responses.issue_laggy === 'yes',
            troubleKeepingHandInView: responses.issue_handView === 'yes',
            otherIssues: responses.issue_other === 'yes'
        },
        demographics: {
            hasNeurologicalConditions: responses.neurological === 'yes',
            hasHandPain: responses.handPain === 'yes',
            hasHandInjuryHistory: responses.handInjuryHistory === 'yes',
            householdIncome: responses.income,
            zipCode: responses.zipcode
        },
        
        feedback: responses.feedback || '',
        
        completedAt: new Date().toISOString(),
        participantID: sessionStorage.getItem('prolificID') || 'anonymous'
    };
    
    console.log("💾 Structured questionnaire data:", questionnaireData);
    
    const participantID = sessionStorage.getItem('prolificID') || 'anonymous';
    
    const savePromise1 = db.collection("Results")
        .doc(participantID)
        .collection("Questionnaire")
        .doc("Responses")
        .set(questionnaireData);
    
    const savePromise2 = db.collection("Participants")
        .doc(participantID)
        .collection("Questionnaire")
        .doc("Demographics")
        .set(questionnaireData);
        
    const savePromise3 = db.collection("QuestionnaireResponses")
        .doc(participantID)
        .set(questionnaireData);
    
    Promise.all([savePromise1, savePromise2, savePromise3])
        .then(() => {
            console.log("✅ Questionnaire data saved successfully to all locations");
            
            document.getElementById('questionnaire-overlay').style.display = 'none';
            showFinalResults();
        })
        .catch(err => {
            console.error("❌ Error saving questionnaire data:", err);
            alert("There was an error saving your responses. Please try again.");
        });
});
        }

        const SMOOTHING_WINDOW = 3;
        const MIN_PEAK_PROMINENCE = 0.3;
        const MIN_PEAK_DISTANCE = 90;
        const CLOSED_THRESHOLD_PCT = 30;
        const OPEN_THRESHOLD_PCT = 35;
        const HAND_TOO_FAR_THRESHOLD = 0.28; 
        const HAND_TOO_CLOSE_THRESHOLD = 0.84; 
        const VELOCITY_THRESHOLD_PERCENTILE = 70;
        const MIN_REQUIRED_TAPS = 15;

        const WRIST = 0;
        const THUMB_TIP = 4;
        const INDEX_TIP = 8;
        const MIDDLE_MCP = 9;

        const POPULATION_NORMS = {
            frequency: {
                healthy: {

                    base_mean_taps_per_10sec: 50.6,
                    base_standard_deviation: 6.3,
                    performance_validity_cutoffs: {
                        men: 36,  
                        women: 29 
                    }
                }
            }
        };
                
        function getDemographicAdjustedNorms() {
            
            const age = parseInt(sessionStorage.getItem('age')) || 30;
            const gender = sessionStorage.getItem('gender') || 'male';
            
            let adjustedMean = 50.6; 
            let adjustedSD = 6.3;   
            
            // Gender adjustments (based on Ruff & Parker, 1993)
            if (gender === 'male') {
                adjustedMean = 53.4; // Men's mean from research
                adjustedSD = 6.0;    // Men's SD from research
            } else if (gender === 'female') {
                adjustedMean = 47.8; // Women's mean from research
                adjustedSD = 5.3;    // Women's SD from research
                
                if (age >= 55) {
                    adjustedMean -= 3.8; // Women 55-70: 45.7 vs 49.5 for 16-24
                } else if (age >= 40) {
                    adjustedMean -= 1.5; // Women 40-54: 47.0 vs 49.5 for 16-24
                }
            }
        
            
            return { mean: adjustedMean, sd: adjustedSD };
        }
 
        
        // Research-based demographic norms from Ruff & Parker (1993)
        const demographicNorms = getDemographicAdjustedNorms();
        const normMean = demographicNorms.mean;
        const normSD = demographicNorms.sd;
                // Initialize MediaPipe Hands
        function initializeHands() {
            try {
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
        
// iPad-specific MediaPipe optimizations
                if (isIPadOrTablet()) {
                    hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 0,  // Reduced from 1 to 0 for iPad only
                        minDetectionConfidence: 0.6,  // Slightly reduced for better performance
                        minTrackingConfidence: 0.6   // Slightly reduced for better performance
                    });
                } else {
                  
                    hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.7,
                        minTrackingConfidence: 0.7
                    });
                }
        
                hands.onResults(onHandsResults);
                
                if (isIPadOrTablet()) {
                    console.log('iPad detected - applying performance optimizations');
                    const originalOnResults = hands.onResults;
                    let frameSkipCounter = 0;
                    
                    hands.onResults = function(results) {
                        frameSkipCounter++;
                        originalOnResults.call(this, results);
                    };
                }
                
                console.log('MediaPipe Hands initialized successfully');
            } catch (error) {
                console.error('Failed to initialize MediaPipe Hands:', error);
                document.getElementById('position-status').textContent = 'Failed to load hand tracking. Please refresh the page.';
            }
        }

        function showMobileLoading() {
            if (window.innerWidth <= 768 || isIPadOrTablet()) {
                const overlay = document.getElementById('mobile-loading-overlay');
                overlay.style.display = 'block';
                updateLoadingProgress(0, "Requesting camera access...");
                setTimeout(() => updateLoadingProgress(25, "Loading hand tracking..."), 500);
                setTimeout(() => updateLoadingProgress(50, "Initializing MediaPipe..."), 1500);
                setTimeout(() => updateLoadingProgress(75, "Starting video feed..."), 3000);
            }
        }

        function updateLoadingProgress(percent, status) {
            const progressBar = document.getElementById('loading-progress');
            const statusText = document.getElementById('loading-status');
            if (progressBar) progressBar.style.width = percent + '%';
            if (statusText) statusText.textContent = status;
        }

        function hideMobileLoading() {
            const overlay = document.getElementById('mobile-loading-overlay');
            if (overlay) {
                updateLoadingProgress(100, "Ready!");
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
            }
        }


                        // Add memory management for iPhone SE
        function addMemoryManagement() {
                    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                        const isIPhoneSE = /iPhone/.test(navigator.userAgent) && 
                                          (screen.width <= 375 && screen.height <= 667);
                        
                        const clearInterval = isIPhoneSE ? 1500 : 5000;
                        const maxFrames = isIPhoneSE ? 150 : 1000;
                        
                        setInterval(() => {
                            if (!recording) {
                                if (frameData.length > maxFrames) {
                                    frameData = frameData.slice(-(maxFrames/2));
                                    console.log(`iOS: Cleared excess frame data (${isIPhoneSE ? 'iPhone SE' : 'iOS'})`);
                                }
                                if (distanceSignal.length > 300) {
                                    distanceSignal = distanceSignal.slice(-150);
                                    timeSignal = timeSignal.slice(-150);
                                    smoothedSignal = smoothedSignal.slice(-150);
                                    velocitySignal = velocitySignal.slice(-150);
                                }
                                // Force garbage collection hint
                                if (window.gc) window.gc();
                            }
                        }, clearInterval);
                        
                        // iPhone SE specific crash prevention
                        if (isIPhoneSE) {
                            window.addEventListener('beforeunload', () => {
                                frameData = null;
                                distanceSignal = null;
                                timeSignal = null;
                                smoothedSignal = null;
                                velocitySignal = null;
                            });
                            
                            setInterval(() => {
                                if (window.performance && window.performance.memory) {
                                    const memUsage = window.performance.memory.usedJSHeapSize / 1048576;
                                    if (memUsage > 30) { // 30MB threshold for iPhone SE
                                        console.log('iPhone SE: High memory usage detected, clearing data');
                                        if (!recording) {
                                            frameData = [];
                                            distanceSignal = [];
                                            timeSignal = [];
                                        }
                                    }
                                }
                            }, 3000);
                        }
                        
                        if ('onmemorywarning' in window) {
                            window.addEventListener('memorywarning', () => {
                                console.log('iOS memory warning - aggressive cleanup');
                                if (!recording) {
                                    frameData = [];
                                    distanceSignal = [];
                                    timeSignal = [];
                                    smoothedSignal = [];
                                    velocitySignal = [];
                                }
                            });
                        }
                    }
        }

        function initializeCamera() {
            const videoElement = document.getElementById('inputVideo');
            const canvasElement = document.getElementById('outputCanvas');
            canvasCtx = canvasElement.getContext('2d');
        
            // Force fresh camera permission request
            const videoConstraints = isIPadOrTablet() ? {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: "user",
                    frameRate: { ideal: 24, max: 30 },
                    // Force permission dialog
                    mandatory: {
                        chromeMediaSource: 'desktop'
                    }
                }
            } : {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    facingMode: "user"
                }
            };
        
            // Always request fresh permissions
            navigator.mediaDevices.getUserMedia(videoConstraints).catch(() => {
                // Fallback without mandatory constraints
                return navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "user"
                    }
                });
            }).then(async (stream) => {
                videoElement.srcObject = stream;
            
                if (window.innerWidth <= 768) {
                    videoElement.setAttribute('playsinline', 'true');
                    videoElement.setAttribute('webkit-playsinline', 'true');
                    videoElement.muted = true;
                    videoElement.autoplay = true;
                    
                    videoElement.addEventListener('loadedmetadata', async () => {
                        try {
                            await videoElement.play();
                            console.log('📱 Mobile video started successfully');
                        } catch (e) {
                            console.warn('📱 Mobile video autoplay blocked, will play on user interaction');
                        }
                    });
                }
            
                videoElement.onloadedmetadata = () => {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    addMemoryManagement(); 
                    hideMobileLoading();
            
                    let lastFrameTime = Date.now();
            
                    const processFrame = async () => {
                        try {
                            if (videoElement.readyState >= 2 && !videoElement.paused) {
                           
                                if (isIPadOrTablet()) {
                                    const now = Date.now();
                         
                                    if (now - iPadLastProcessedFrame < 16) { 
                                        requestAnimationFrame(processFrame);
                                        return;
                                    }
                                    iPadLastProcessedFrame = now;
                                }
                                
                                await hands.send({ image: videoElement });
                                lastFrameTime = Date.now();
                            }
                        } catch (err) {
                            console.warn("MediaPipe processing error:", err);
                        }
                        requestAnimationFrame(processFrame);
                    };
            
                    const startWatchdog = () => {
                        setInterval(async () => {
                            const now = Date.now();
                            if (now - lastFrameTime > 3000) {
                                console.warn("Hand tracking frozen, restarting...");
                                try {
                                    hands.close();
                                    initializeHands();
                                    
                                    if (window.innerWidth <= 768 && videoElement.paused) {
                                        await videoElement.play();
                                    }
                                } catch (e) {
                                    console.warn("Restart failed:", e);
                                }
                            }
                        }, 2000);
                    };
            
                    requestAnimationFrame(processFrame);
                    startWatchdog();
                };
            }).catch(err => {
                            console.error("Camera access error:", err);
                            hideMobileLoading();
                            alert("Camera access denied. Please refresh and grant camera permissions.");
            });
        }

        function calculateFPS() {
            const now = performance.now();
            frameTimestamps.push(now);
            
            // Keep only last 60 frames
            if (frameTimestamps.length > 60) {
                frameTimestamps.shift();
            }
            
            // Calculate FPS every second
            if (now - lastFpsCalcTime > 1000 && frameTimestamps.length > 10) {
                const timeSpan = frameTimestamps[frameTimestamps.length - 1] - frameTimestamps[0];
                const fps = ((frameTimestamps.length - 1) / timeSpan) * 1000;
                fpsHistory.push({
                    timestamp: Date.now(),
                    fps: Math.round(fps * 10) / 10
                });
                lastFpsCalcTime = now;
                
                // Keep only last 100 FPS measurements
                if (fpsHistory.length > 100) {
                    fpsHistory.shift();
                }
            }
        }

        function movingAverage(data, windowSize) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                let start = Math.max(0, i - Math.floor(windowSize / 2));
                let end = Math.min(data.length, i + Math.floor(windowSize / 2) + 1);
                let sum = 0;
                for (let j = start; j < end; j++) {
                    sum += data[j];
                }
                result.push(sum / (end - start));
            }
            return result;
        }

        function calculateDerivative(data, timeData) {
            const derivative = [];
            for (let i = 1; i < data.length; i++) {
                const dt = (timeData[i] - timeData[i-1]) / 1000;
                const dy = data[i] - data[i-1];
                derivative.push(dy / dt);
            }
            return derivative;
        }

        function findPeaks(signal, prominence = MIN_PEAK_PROMINENCE) {
            const peaks = [];
            
            const mean = signal.reduce((a, b) => a + b, 0) / signal.length;
            const variance = signal.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / signal.length;
            const std = Math.sqrt(variance);
            
            const threshold = mean + prominence * std;
            
            for (let i = 1; i < signal.length - 1; i++) {
                if (signal[i] > signal[i-1] && signal[i] > signal[i+1] && signal[i] > threshold) {
                    if (peaks.length === 0 || (timeSignal[i] - timeSignal[peaks[peaks.length - 1]]) > MIN_PEAK_DISTANCE) {
                        peaks.push(i);
                    }
                }
            }
            
            return peaks;
        }

        function detectTapsFromVelocity(velocitySignal, distanceSignal) {
            const taps = [];
            let state = 'open';
            let lastTapTime = -Infinity;

            for (let i = 1; i < velocitySignal.length - 1; i++) {
                const t = timeSignal[i];
                const dist = distanceSignal[i];
                const velPrev = velocitySignal[i - 1];
                const velCurr = velocitySignal[i];

                switch (state) {
                    case 'open':
                        if (dist < 30 && velPrev < 0 && velCurr >= 0) {
                            if ((t - lastTapTime) > MIN_PEAK_DISTANCE) {
                                taps.push({
                                    index: i,
                                    time: t,
                                    amplitude: dist
                                });
                                lastTapTime = t;
                                state = 'must_open';
                            }
                        }
                        break;

                    case 'must_open':
                        if (dist > 35) {
                            state = 'open';
                        }
                        break;

                    default:
                        state = 'open';
                }
            }

            return taps;
        }

function onHandsResults(results) {
    calculateFPS();
    
    const canvasElement = document.getElementById('outputCanvas');
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        handDetected = true;
        const landmarks = results.multiHandLandmarks[0];
        frameCount++;

        if (recording) {
            lastHandSeenTime = Date.now();
        }
        
        // Get hand label (flip because the video/canvas are mirrored)
        if (results.multiHandedness && results.multiHandedness.length > 0) {
          // pick highest-score hand classification
          const best = results.multiHandedness
            .slice()
            .sort((a, b) => (b.score ?? 0) - (a.score ?? 0))[0];
        
          let raw = best?.label?.toLowerCase() || null; // "left" | "right"
          if (raw) {
            // Flip only because we draw with scaleX(-1)
            const logical = VIDEO_MIRRORED ? (raw === "right" ? "left" : "right") : raw;
            pushHandLabel(logical);
       
            const stable = getStableHandLabel();
            currentDetectedHand = recording ? (currentDetectedHand || stable) : stable;
          } else {
            currentDetectedHand = null;
            handLabelBuffer = [];
          }
        } else {
          currentDetectedHand = null;
          handLabelBuffer = [];
        }
        
        
        if (!recording) {
            updateHandPositionFeedback(landmarks);
            
            if (readyToStart && isCorrectHandDetectedForCurrentTrial()) {
                detectPreStartTaps(landmarks, results.image.width, results.image.height);
            }
        }
        if (recording) {
            const currentTime = Date.now() - startTime;
            if (currentTime < recordingDuration) {
         
                    if (isCorrectHandDetectedForCurrentTrial()) {
     
                        if (isIPadOrTablet()) {
                            processFingerTapAdvancedIPad(landmarks, results.image.width, results.image.height);
                        } else {
                            processFingerTapAdvanced(landmarks, results.image.width, results.image.height);
                        }
                } else {
                   
                    console.log("Wrong hand detected during recording, restarting trial");
                    restartTrialDueToWrongHand();
                    return;
                }
            }
        }
        
        if (isIPadOrTablet()) {
            drawHandVisualizationIPad(landmarks, canvasElement);
        } else {
            drawHandVisualization(landmarks, canvasElement);
        }
        
    } else {
        handDetected = false;
        currentDetectedHand = null;
        
        if (!recording) {
            updateHandPositionFeedback(null);
        }
    }
    
    canvasCtx.restore();
 }


        function detectPreStartTaps(landmarks, imageWidth, imageHeight) {

            const overlay = document.getElementById('trial-instructions-overlay');
            if (overlay && overlay.style.display === 'flex') {
                return;
            }
            
            const currentTime = Date.now();
            
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const wrist = landmarks[WRIST];
            const middleMcp = landmarks[MIDDLE_MCP];
            
            const handSize = Math.sqrt(
                Math.pow((wrist.x - middleMcp.x) * imageWidth, 2) +
                Math.pow((wrist.y - middleMcp.y) * imageHeight, 2)
            );
            
            const distance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * imageWidth, 2) +
                Math.pow((thumbTip.y - indexTip.y) * imageHeight, 2) +
                Math.pow((thumbTip.z - indexTip.z) * imageWidth * 0.5, 2)
            );
            
            const normalizedDistance = (distance / handSize) * 100;
            
            if (normalizedDistance < 40) { 
                if (currentTime - lastPreStartTapTime > 100) { // Faster detection
                    console.log("🚀 TAP DETECTED - STARTING NOW! Distance:", normalizedDistance);
                    lastPreStartTapTime = currentTime;
                    startActualRecording();
                    return;
                }
            }
        }
        function updateHandPositionFeedback(landmarks) {
            const positionStatus = document.getElementById('position-status');
            const handOutline = document.getElementById('hand-outline');
            
            if (!landmarks) {
                positionStatus.textContent = 'No hand detected';
                positionStatus.className = 'position-status error';
                handOutline.classList.remove('hand-outline-ready');
                handOutline.classList.add('hand-outline-not-ready');
                window.handPositionCorrect = false;
                return;
            }
        
            const wrist = landmarks[WRIST];
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const middleMcp = landmarks[MIDDLE_MCP];
            
            const handSize = Math.sqrt(
                Math.pow((wrist.x - middleMcp.x), 2) +
                Math.pow((wrist.y - middleMcp.y), 2)
            );

            const goodDistance = (handSize > 0.18 && handSize < 0.55);
                                    
            const fingerDistance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x), 2) +
                Math.pow((thumbTip.y - indexTip.y), 2)
            );
            
            const fingersOpen = (fingerDistance > 0.08);
            
            window.handPositionCorrect = goodDistance && fingersOpen;
            
            if (!isCorrectHandDetectedForCurrentTrial()) {
                const requiredHand = trialConditions[trialIndex % trialConditions.length].hand.toUpperCase();
                positionStatus.textContent = `Wrong hand! Use ${requiredHand} hand`;
                positionStatus.className = 'position-status error';
                handOutline.classList.remove('hand-outline-ready');
                handOutline.classList.add('hand-outline-not-ready');
                } else if (goodDistance && fingersOpen) {
                    positionStatus.innerHTML = 'The timer starts once you begin tapping<br>as fast as you can for 10 seconds.';


                    positionStatus.className = 'position-status ready';
                    handOutline.classList.remove('hand-outline-not-ready');
                    handOutline.classList.add('hand-outline-ready');
                    
                    positionStatus.style.cursor = '';
                    positionStatus.onclick = null;

            } else {
                handOutline.classList.remove('hand-outline-ready');
                handOutline.classList.add('hand-outline-not-ready');
                positionStatus.className = 'position-status warning';
                positionStatus.style.cursor = '';
                positionStatus.onclick = null;
                
                if (!goodDistance) {
                    const tooClose = 0.15;
                    const tooFar = 0.58; 
                    if (handSize < tooClose) {
                        positionStatus.textContent = 'Move closer to camera';
                    } else if (handSize > tooFar) {
                        positionStatus.textContent = 'Move back from camera';
                    } else {
                        positionStatus.textContent = 'Adjust distance';
                    }
                } else if (!fingersOpen) {
                    positionStatus.textContent = 'Open fingers wider';
                }
            }
        }
        function drawHandVisualization(landmarks, canvasElement) {
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const distance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * canvasElement.width, 2) +
                Math.pow((thumbTip.y - indexTip.y) * canvasElement.height, 2)
            );
            
            const isTapping = recording && distance < 30;
            
            let justTapped = false;
            if (recording && tapEvents.length > 0) {
                const currentTime = Date.now() - startTime;
                const lastTap = tapEvents[tapEvents.length - 1];
                justTapped = (currentTime - lastTap.time) < 150;
            }
            
            // Clean visual feedback
            let dotColor = '#ffffff';
            let lineColor = 'rgba(255, 255, 255, 0.5)';
            let dotSize = 10;
            
            if (justTapped) {
                dotColor = '#22c55e';
                lineColor = 'rgba(34, 197, 94, 1)';
                dotSize = 14;
                canvasCtx.shadowBlur = 20;
                canvasCtx.shadowColor = '#22c55e';
            } else if (isTapping) {
                dotColor = '#16a34a';
                lineColor = 'rgba(22, 163, 74, 0.8)';
                dotSize = 12;
            }
            
            // Draw connection line
            canvasCtx.strokeStyle = lineColor;
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            canvasCtx.moveTo(thumbTip.x * canvasElement.width, thumbTip.y * canvasElement.height);
            canvasCtx.lineTo(indexTip.x * canvasElement.width, indexTip.y * canvasElement.height);
            canvasCtx.stroke();
            
            // Draw finger dots
            [thumbTip, indexTip].forEach(tip => {
                // Outer glow
                canvasCtx.fillStyle = dotColor;
                canvasCtx.globalAlpha = 0.3;
                canvasCtx.beginPath();
                canvasCtx.arc(tip.x * canvasElement.width, tip.y * canvasElement.height, dotSize + 4, 0, 2 * Math.PI);
                canvasCtx.fill();

                // Inner dot
                canvasCtx.globalAlpha = 1;
                canvasCtx.fillStyle = dotColor;
                canvasCtx.beginPath();
                canvasCtx.arc(tip.x * canvasElement.width, tip.y * canvasElement.height, dotSize, 0, 2 * Math.PI);
                canvasCtx.fill();
            });
            
            canvasCtx.shadowBlur = 0;
        }

        function processFingerTapAdvanced(landmarks, imageWidth, imageHeight) {
            const currentTime = Date.now() - startTime;
            
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const wrist = landmarks[WRIST];
            const middleMcp = landmarks[MIDDLE_MCP];
            
            const handSize = Math.sqrt(
                Math.pow((wrist.x - middleMcp.x) * imageWidth, 2) +
                Math.pow((wrist.y - middleMcp.y) * imageHeight, 2)
            );
            
            const distance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * imageWidth, 2) +
                Math.pow((thumbTip.y - indexTip.y) * imageHeight, 2) +
                Math.pow((thumbTip.z - indexTip.z) * imageWidth * 0.5, 2)
            );
            
            const normalizedDistance = (distance / handSize) * 100;
            
            distanceSignal.push(normalizedDistance);
            timeSignal.push(currentTime);
            if (frameCount % 30 === 0) {
                console.log(`iPad Performance Check - Frame ${frameCount}: ${tapEvents.length} taps detected, Signal length: ${distanceSignal.length}`);
            }
 
            if (recording) {
                const tapWidthFeedback = document.getElementById('tapWidthFeedback');
                const tapWidthMessage = document.getElementById('tapWidthMessage');
                
                const recentSamples = distanceSignal.slice(-30);
                const maxRecentAmplitude = Math.max(...recentSamples);
                
                if (!window.tapFeedbackTimer) {
                    window.tapFeedbackTimer = 0;
                }
                
                if (maxRecentAmplitude < 45) {
                    tapWidthFeedback.style.display = 'block';
                    tapWidthMessage.textContent = 'Open fingers wider';
                    window.tapFeedbackTimer = 45;
                } else if (window.tapFeedbackTimer > 0) {
                    window.tapFeedbackTimer--;
                } else {
                    tapWidthFeedback.style.display = 'none';
                }
            }
                        
            if (distanceSignal.length > SMOOTHING_WINDOW) {
                smoothedSignal = movingAverage(distanceSignal, SMOOTHING_WINDOW);
                
                if (smoothedSignal.length > 1) {
                    velocitySignal = calculateDerivative(smoothedSignal, timeSignal);
                }
                
                detectTapsMultiMethod();


            }
  

            frameData = frameData || [];
            frameData.push({
                timestamp: currentTime,
                normalizedDistance: normalizedDistance,
                thumbIndexAngle: Math.atan2(
                    (indexTip.y - thumbTip.y),
                    (indexTip.x - thumbTip.x)
                ) * 180 / Math.PI,
                handSize: handSize,
                thumbTip: { x: thumbTip.x, y: thumbTip.y, z: thumbTip.z },
                indexTip: { x: indexTip.x, y: indexTip.y, z: indexTip.z },
                wrist: { x: wrist.x, y: wrist.y, z: wrist.z },
                middleMcp: { x: middleMcp.x, y: middleMcp.y, z: middleMcp.z },
                rawLandmarks: landmarks.map(lm => ({ x: lm.x, y: lm.y, z: lm.z }))
            });
        }

        function processFingerTapAdvancedIPad(landmarks, imageWidth, imageHeight) {
            const currentTime = Date.now() - startTime;
        
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const wrist = landmarks[WRIST];
            const middleMcp = landmarks[MIDDLE_MCP];
        
            const handSize = Math.sqrt(
                Math.pow((wrist.x - middleMcp.x) * imageWidth, 2) +
                Math.pow((wrist.y - middleMcp.y) * imageHeight, 2)
            );
        
            const distance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * imageWidth, 2) +
                Math.pow((thumbTip.y - indexTip.y) * imageHeight, 2) +
                Math.pow((thumbTip.z - indexTip.z) * imageWidth * 0.5, 2)
            );
        
            const normalizedDistance = (distance / handSize) * 100;
        
            distanceSignal.push(normalizedDistance);
            timeSignal.push(currentTime);
        
            if (recording && frameCount % 3 === 0) {
                const tapWidthFeedback = document.getElementById('tapWidthFeedback');
                const tapWidthMessage = document.getElementById('tapWidthMessage');
        
                const recentSamples = distanceSignal.slice(-30);
                const maxRecentAmplitude = Math.max(...recentSamples);
        
                if (!window.tapFeedbackTimer) {
                    window.tapFeedbackTimer = 0;
                }
        
                if (maxRecentAmplitude < 45) {
                    tapWidthFeedback.style.display = 'block';
                    tapWidthMessage.textContent = 'Open fingers wider';
                    window.tapFeedbackTimer = 45;
                } else if (window.tapFeedbackTimer > 0) {
                    window.tapFeedbackTimer--;
                } else {
                    tapWidthFeedback.style.display = 'none';
                }
            }
        
            if (distanceSignal.length > SMOOTHING_WINDOW) {
                smoothedSignal = movingAverage(distanceSignal, SMOOTHING_WINDOW);
        
                if (smoothedSignal.length > 1) {
                    velocitySignal = calculateDerivative(smoothedSignal, timeSignal);
           
                    detectTapsMultiMethodIPad();
                }
            }
        
            const essentialFrameData = {
                timestamp: currentTime,
                normalizedDistance: normalizedDistance,
                thumbIndexAngle: Math.atan2(
                    (indexTip.y - thumbTip.y),
                    (indexTip.x - thumbTip.x)
                ) * 180 / Math.PI,
                handSize: handSize,
                thumbTip: { x: thumbTip.x, y: thumbTip.y, z: thumbTip.z },
                indexTip: { x: indexTip.x, y: indexTip.y, z: indexTip.z },
                wrist: { x: wrist.x, y: wrist.y, z: wrist.z },
                middleMcp: { x: middleMcp.x, y: middleMcp.y, z: middleMcp.z },
                rawLandmarks: [
                    landmarks[WRIST], landmarks[THUMB_TIP],
                    landmarks[INDEX_TIP], landmarks[MIDDLE_MCP]
                ].map(lm => ({ x: lm.x, y: lm.y, z: lm.z }))
            };
        
            frameData = frameData || [];
            frameData.push(essentialFrameData);
        }
        

        
        function detectTapsMultiMethodIPad() {
            const rawEvents = [];
            const added = new Set();
            
            // Detect iPhone 16 Pro specifically for ultra-sensitive detection
            const isIPhone16Pro = /iPhone/.test(navigator.userAgent) && window.devicePixelRatio === 3;
            const sensitivity = isIPhone16Pro ? 0.8 : 1.0;
        
            // Strategy 1: Ultra-sensitive state change detection for iPhone 16 Pro
            let lastState = 'unknown';
            for (let i = 2; i < distanceSignal.length; i++) {
                const current = distanceSignal[i];
                const prev = distanceSignal[i - 1];
                const prevPrev = distanceSignal[i - 2];
                
                const delta = current - prev;
                const trend = (current - prevPrev) / 2;

                const sensitivity = isIPhone16Pro ? 0.8 : 1.0;
                const threshold = isIPhone16Pro ? -1.0 : -2.0;
        
                let currentState = 'stable';
                if (delta < threshold * sensitivity || trend < threshold * sensitivity) currentState = 'closing';
                else if (delta > -threshold * sensitivity || trend > -threshold * sensitivity) currentState = 'opening';
        
                if (currentState === 'closing' && lastState !== 'closing' && current < (isIPhone16Pro ? 70 : 60)) {
                    const time = timeSignal[i];
                    const minGap = isIPhone16Pro ? 18 : 25;
                    const lastEventTime = rawEvents.length > 0 ? rawEvents[rawEvents.length - 1].time : -1000;
                    if (time - lastEventTime > minGap) {
                        rawEvents.push({
                            index: i,
                            time,
                            amplitude: current,
                            type: 'state_change'
                        });
                        added.add(i);
                    }
                }
                lastState = currentState;
            }
        
            // Strategy 2: Hyper-sensitive local minima for iPhone 16 Pro
            for (let i = 1; i < distanceSignal.length - 1; i++) {
                const current = distanceSignal[i];
                const prev = distanceSignal[i - 1];
                const next = distanceSignal[i + 1];
                
                const threshold = isIPhone16Pro ? 65 : 55;
                const isLocalMin = current <= prev && current <= next && current < threshold;
                
                if (isLocalMin && !added.has(i)) {
                    const time = timeSignal[i];
                    const minGap = isIPhone16Pro ? 18 : 25;
                    const lastEventTime = rawEvents.length > 0 ? rawEvents[rawEvents.length - 1].time : -1000;
                    if (time - lastEventTime > minGap) {
                        rawEvents.push({
                            index: i,
                            time,
                            amplitude: current,
                            type: 'local_min'
                        });
                        added.add(i);
                    }
                }
            }
        
            // Strategy 3: Ultra-sensitive velocity detection for iPhone 16 Pro
            if (velocitySignal.length > 2) {
                for (let i = 1; i < velocitySignal.length - 1; i++) {
                    const prevVel = velocitySignal[i - 1];
                    const currVel = velocitySignal[i];
                    
                    const velThreshold = isIPhone16Pro ? -0.15 : -0.3;
                    const crossingPoint = (prevVel < velThreshold && currVel >= velThreshold) || 
                                         (prevVel < 0 && currVel >= 0);
                    const distThreshold = isIPhone16Pro ? 70 : 60;
                    const atGoodDistance = distanceSignal[i] < distThreshold;
        
                    if (crossingPoint && atGoodDistance && !added.has(i)) {
                        const time = timeSignal[i];
                        const minGap = isIPhone16Pro ? 18 : 25;
                        const lastEventTime = rawEvents.length > 0 ? rawEvents[rawEvents.length - 1].time : -1000;
                        if (time - lastEventTime > minGap) {
                            rawEvents.push({
                                index: i,
                                time,
                                amplitude: distanceSignal[i],
                                type: 'velocity_cross'
                            });
                            added.add(i);
                        }
                    }
                }
            }
        
            // Strategy 4: Micro-movement detection for iPhone 16 Pro
            if (isIPhone16Pro && distanceSignal.length > 5) {
                for (let i = 2; i < distanceSignal.length - 2; i++) {
                    const window = distanceSignal.slice(i-2, i+3);
                    const minInWindow = Math.min(...window);
                    
                    if (distanceSignal[i] === minInWindow && distanceSignal[i] < 65 && !added.has(i)) {
                        const time = timeSignal[i];
                        const lastEventTime = rawEvents.length > 0 ? rawEvents[rawEvents.length - 1].time : -1000;
                        if (time - lastEventTime > 18) {
                            rawEvents.push({
                                index: i,
                                time,
                                amplitude: distanceSignal[i],
                                type: 'micro_movement'
                            });
                            added.add(i);
                        }
                    }
                }
            }
        
            // Sort and enforce minimal spacing
            rawEvents.sort((a, b) => a.time - b.time);
            tapEvents = [];
            const minSpacing = isIPhone16Pro ? 18 : 25;
            
            for (const ev of rawEvents) {
                if (tapEvents.length === 0 || ev.time - tapEvents[tapEvents.length - 1].time >= minSpacing) {
                    tapEvents.push(ev);
                }
            }
        
            if (frameCount % 30 === 0 && tapEvents.length > 0) {
                const tapsPerSecond = tapEvents.length / ((timeSignal[timeSignal.length - 1] || 1000) / 1000);
                const deviceInfo = isIPhone16Pro ? 'iPhone 16 Pro' : 'iPad/Mobile';
                console.log(`${deviceInfo} Enhanced Detection: ${tapEvents.length} taps, ${tapsPerSecond.toFixed(1)} taps/sec`);
            }
        }
        function drawHandVisualizationIPad(landmarks, canvasElement) {
            const thumbTip = landmarks[THUMB_TIP];
            const indexTip = landmarks[INDEX_TIP];
            const distance = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * canvasElement.width, 2) +
                Math.pow((thumbTip.y - indexTip.y) * canvasElement.height, 2)
            );
            
            const isTapping = recording && distance < 30;
            
            let justTapped = false;
            if (recording && tapEvents.length > 0) {
                const currentTime = Date.now() - startTime;
                const lastTap = tapEvents[tapEvents.length - 1];
                justTapped = (currentTime - lastTap.time) < 150;
            }
            
            let dotColor = '#ffffff';
            let lineColor = 'rgba(255, 255, 255, 0.5)';
            let dotSize = 10;
            
            if (justTapped) {
                dotColor = '#22c55e';
                lineColor = 'rgba(34, 197, 94, 1)';
                dotSize = 14;
                
            } else if (isTapping) {
                dotColor = '#16a34a';
                lineColor = 'rgba(22, 163, 74, 0.8)';
                dotSize = 12;
            }
            
            canvasCtx.strokeStyle = lineColor;
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            canvasCtx.moveTo(thumbTip.x * canvasElement.width, thumbTip.y * canvasElement.height);
            canvasCtx.lineTo(indexTip.x * canvasElement.width, indexTip.y * canvasElement.height);
            canvasCtx.stroke();
            
            [thumbTip, indexTip].forEach(tip => {
            
                canvasCtx.globalAlpha = 1;
                canvasCtx.fillStyle = dotColor;
                canvasCtx.beginPath();
                canvasCtx.arc(tip.x * canvasElement.width, tip.y * canvasElement.height, dotSize, 0, 2 * Math.PI);
                canvasCtx.fill();
            });
        }

        function updateLiveMetrics() {
            const currentTime = Date.now() - startTime;
            const remaining = Math.max(0, (recordingDuration - currentTime) / 1000);
            const minutes = Math.floor(remaining / 60);
            const seconds = Math.floor(remaining % 60) + 1;
            const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const centerTimer = document.getElementById('center-timer');
            centerTimer.textContent = timerText;
            centerTimer.setAttribute('data-taps', tapEvents.length);
            
        }

           
function detectTapsMultiMethod() {
    const rawEvents = [];
    const added = new Set();

    // Strategy 1: Velocity-based detection (original)
    detectTapsFromVelocity(velocitySignal, smoothedSignal).forEach(ev => {
        if (!added.has(ev.index)) { rawEvents.push(ev); added.add(ev.index); }
    });

    // Strategy 2: Peak detection (original)
    const inverted = smoothedSignal.map(d => 100 - d);
    findPeaks(inverted, 0.5).forEach(idx => {
        if (smoothedSignal[idx] < CLOSED_THRESHOLD_PCT && !added.has(idx)) {
            rawEvents.push({ index: idx, time: timeSignal[idx], amplitude: smoothedSignal[idx] });
            added.add(idx);
        }
    });

    // Sort events
    rawEvents.sort((a, b) => a.time - b.time);
    tapEvents = [];

    // Enforce reopening requirement (ORIGINAL LOGIC - CRITICAL!)
    for (const ev of rawEvents) {
        if (tapEvents.length === 0) {
            tapEvents.push(ev);
            continue;
        }

        const last = tapEvents[tapEvents.length - 1];

        // Minimum time spacing
        if (ev.time - last.time < MIN_PEAK_DISTANCE) continue;

        // MUST reopen between taps (THIS IS THE KEY PART)
        let reopened = false;
        for (let i = last.index + 1; i < ev.index; i++) {
            if (smoothedSignal[i] > OPEN_THRESHOLD_PCT) { 
                reopened = true; 
                break; 
            }
        }
        if (!reopened) continue; // Skip if fingers didn't reopen

        tapEvents.push(ev);
    }
}

        function startRecording() {
          
            if (window.innerWidth <= 768) {
             
                if (!handDetected) {
                    const positionStatus = document.getElementById('position-status');
                    positionStatus.textContent = 'Show your hand to camera';
                    positionStatus.className = 'position-status error';
                    return;
                }
            } else {
                if (!handDetected) {
                    alert('Please position your hand in view of the camera before starting.');
                    return;
                }
        
                if (!window.handPositionCorrect) {
                    alert('Please position your hand correctly with fingers open before starting.');
                    return;
                }
        
                if (!isCorrectHandDetectedForCurrentTrial()) {
                    const required = trialConditions[trialIndex % trialConditions.length].hand.toUpperCase();
                    alert(`Please show your ${required} hand before starting.`);
                    return;
                }
            }
        
            if (trialIndex >= totalTrials) {
                if (window.innerWidth <= 768) {
                    const positionStatus = document.getElementById('position-status');
                    positionStatus.textContent = 'All trials complete!';
                    return;
                } else {
                    alert('All trials complete!');
                    return;
                }
            }
            distanceSignal = [];
            timeSignal = [];
            smoothedSignal = [];
            velocitySignal = [];
            tapEvents = [];
            frameCount = 0;
            frameData = [];
            
            if (countdownInterval) {
              clearInterval(countdownInterval);
              countdownInterval = null;
            }
            
            
            let countdown = 3;
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';
            countdownEl.textContent = countdown;
        
            countdownInterval = setInterval(() => {
                if (window.innerWidth <= 768) {
                    if (!handDetected) {
                        clearInterval(countdownInterval);
                        countdownEl.style.display = 'none';
                        const positionStatus = document.getElementById('position-status');
                        positionStatus.textContent = 'Hand lost - try again';
                        positionStatus.className = 'position-status error';
                        return;
                    }
                } else {
                    if (!handDetected || !isCorrectHandDetectedForCurrentTrial()) {
                        clearInterval(countdownInterval);
                        countdownEl.style.display = 'none';
                        window.handPositionCorrect = false;
                        return;
                    }
                }
                
                countdown--;
                if (countdown > 0) {
                    countdownEl.textContent = countdown;
                    countdownEl.style.animation = 'none';
                    setTimeout(() => {
                        countdownEl.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                } else {
                    clearInterval(countdownInterval);
                    countdownEl.style.display = 'none';
                    startActualRecording();
                }
            }, 1000);
        }


 function startActualRecording() {

    currentTrialToken++;
    const myToken = currentTrialToken;
    activeTrialToken = myToken;

    readyToStart = false;
    preStartTapCount = 0;
    lastPreStartTapTime = 0;

    window.preStartDistanceSignal = [];
    window.preStartTimeSignal = [];

    document.getElementById('hand-guide-overlay').style.display = 'none';
    document.getElementById('hand-outline').style.display = 'none';

    recording = true;
    const centerTimer = document.getElementById('center-timer');
    if (centerTimer) { centerTimer.style.display = 'block'; }

    startTime = Date.now();
    lastHandSeenTime = Date.now();
    lastTapTime = 0;

    distanceSignal = [];
    timeSignal = [];
    smoothedSignal = [];
    velocitySignal = [];
    tapEvents = [];
    frameCount = 0;
    frameData = [];
    if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
    if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
    if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

    mainTimerInterval = setInterval(() => {
        if (myToken !== activeTrialToken) {
            clearInterval(mainTimerInterval);
            mainTimerInterval = null;
            return;
        }

        const currentTime = Date.now() - startTime;
        const remaining = Math.max(0, (recordingDuration - currentTime) / 1000);

        // Hand-loss window
        if (!handDetected) {
            const timeSinceLastSeen = Date.now() - lastHandSeenTime;
            if (timeSinceLastSeen > MAX_ALLOWED_HAND_LOSS) {
           
                restartTrialDueToHandLoss();
                return;
            }
        } else {
            lastHandSeenTime = Date.now();
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = Math.max(1, Math.ceil(remaining % 60));
        const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        const centerTimer = document.getElementById('center-timer');
        centerTimer.textContent = timerText;
        centerTimer.setAttribute('data-taps', tapEvents.length);
        if (currentTime >= recordingDuration) {
            stopRecording(); 
        }
    }, 100);

    inactivityInterval = setInterval(() => {

        if (myToken !== activeTrialToken || !recording) {
            clearInterval(inactivityInterval);
            inactivityInterval = null;
            return;
        }

        const nowMs = Date.now() - startTime;

        if (nowMs > MAX_ALLOWED_NO_TAPS && tapEvents.length === 0) {
            clearInterval(inactivityInterval);
            inactivityInterval = null;
            restartTrialDueToInactivity();
            return;
        }

        if (tapEvents.length > 0) {
            const lastTapTimestamp = tapEvents[tapEvents.length - 1].time;
            const timeSinceLastTap = nowMs - lastTapTimestamp;
            if (timeSinceLastTap > MAX_ALLOWED_NO_TAPS) {
                clearInterval(inactivityInterval);
                inactivityInterval = null;
                restartTrialDueToInactivity();
                return;
            }
        }
    }, 500);

    stopTimeoutId = setTimeout(() => {
        if (recording && myToken === activeTrialToken) {
            stopRecording();
        }
    }, recordingDuration);
}


function stopRecording() {
    if (!recording) return;

    recording = false;
    const frameDataCopy = [...frameData];
    // Clear memory to prevent crashes
    frameData = [];
    distanceSignal = [];
    timeSignal = [];
    smoothedSignal = [];
    velocitySignal = [];
    const centerTimer = document.getElementById('center-timer');
    if (centerTimer) { centerTimer.style.display = 'none'; }


    if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
    if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
    if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

    document.getElementById('tapWidthFeedback').style.display = 'none';
    window.tapFeedbackTimer = 0;
    window.handPositionCorrect = false;

    document.getElementById('countdown').style.display = 'none';

    document.getElementById('hand-guide-overlay').style.display = 'block';
    document.getElementById('hand-outline').style.display = 'block';

    const positionStatus = document.getElementById('position-status');
    positionStatus.textContent = 'Analyzing results...';
    positionStatus.className = 'position-status warning';

    // Check if minimum taps were achieved
    if (tapEvents.length < MIN_REQUIRED_TAPS) {
        showInsufficientTapsRestart();
        return;
    }

    const result = calculateClinicalAssessment();
    const trialDocName = `trial_${trialIndex + 1}`;

    const essentialFrameData = frameData.map(f => ({
        t: f.timestamp,
        normDist: f.normalizedDistance,
        angle: f.thumbIndexAngle,
        handSize: f.handSize,
        thumb: f.thumbTip,
        index: f.indexTip,
        wrist: f.wrist
    }));

    const avgFPS = fpsHistory.length > 0 
        ? fpsHistory.reduce((a, b) => a + b.fps, 0) / fpsHistory.length 
        : 0;
    
    db.collection("Participants")
      .doc(participantID)
      .collection("Trials")
      .doc(trialDocName)
      .set({
          trialNumber: trialIndex + 1,
          condition: trialConditions[trialIndex % trialConditions.length],
          timestamp: new Date().toISOString(),
          rawFrames: essentialFrameData,
          totalFramesRecorded: frameData.length,
          performanceMetrics: {
              averageFPS: Math.round(avgFPS * 10) / 10,
              minFPS: fpsHistory.length > 0 ? Math.min(...fpsHistory.map(f => f.fps)) : 0,
              maxFPS: fpsHistory.length > 0 ? Math.max(...fpsHistory.map(f => f.fps)) : 0,
              fpsHistory: fpsHistory.slice(-30)
          }
      })

        
      .then(() => console.log(`✅ Essential trial data saved for ${participantID} / ${trialDocName}`))
      .catch(err => console.error("❌ Error saving essential trial data:", err));

    saveLandmarkDataAsync(participantID, trialIndex + 1, trialConditions[trialIndex % trialConditions.length], frameData);

    totalTapsAcrossAllTrials += tapEvents.length;

    allTrialResults.push({
        condition: trialConditions[trialIndex % trialConditions.length],
        repetition: Math.floor(trialIndex / trialConditions.length) + 1,
        result: result
    });

    trialIndex++;

    if (trialIndex < totalTrials) {
        positionStatus.textContent = 'Ready for next trial';
        positionStatus.className = 'position-status ready';

        readyToStart = true;
        preStartTapCount = 0;
        lastPreStartTapTime = 0;

        updateConditionUI();
    } else {
        analyzeAllTrials();
    }
}


// FIXED: Optimized batch saving with fewer landmarks and grouped frames
async function saveLandmarkDataAsync(participantID, trialNumber, condition, frameData) {
    console.log(`💾 Starting optimized batch save of ${frameData.length} frames`);
    
    setTimeout(async () => {
        try {
            const FRAMES_PER_BATCH = 30;
            const totalFrames = frameData.length;
            let savedBatches = 0;
            
            for (let batchStart = 0; batchStart < totalFrames; batchStart += FRAMES_PER_BATCH) {
                const batchEnd = Math.min(batchStart + FRAMES_PER_BATCH, totalFrames);
                const batchFrames = frameData.slice(batchStart, batchEnd);
                
                const batchDocId = `${participantID}_trial${trialNumber}_batch${Math.floor(batchStart / FRAMES_PER_BATCH)}`;
                
                const batchDocument = {
                    participantID: participantID,
                    trialID: `trial_${trialNumber}`,
                    trialNumber: trialNumber,
                    batchIndex: Math.floor(batchStart / FRAMES_PER_BATCH),
                    condition_hand: condition.hand,
                    frameStartIndex: batchStart,
                    frameEndIndex: batchEnd - 1,
                    frameCount: batchFrames.length,
                    
                    timestamps: [],
                    normalizedDistances: [],
                    thumbIndexAngles: [],
                    handSizes: [],
                    
                    // Only the 4 essential landmarks as arrays
                    wrist_x: [], wrist_y: [], wrist_z: [],
                    thumbTip_x: [], thumbTip_y: [], thumbTip_z: [],
                    indexTip_x: [], indexTip_y: [], indexTip_z: [],
                    middleMcp_x: [], middleMcp_y: [], middleMcp_z: []
                };
                
                batchFrames.forEach((frame, frameIndex) => {
                    batchDocument.timestamps.push(frame.timestamp);
                    batchDocument.normalizedDistances.push(frame.normalizedDistance);
                    batchDocument.thumbIndexAngles.push(frame.thumbIndexAngle);
                    batchDocument.handSizes.push(frame.handSize);
                    
                    if (frame.rawLandmarks && Array.isArray(frame.rawLandmarks)) {
                        // WRIST (landmark 0)
                        const wrist = frame.rawLandmarks[0] || {};
                        batchDocument.wrist_x.push(wrist.x || 0);
                        batchDocument.wrist_y.push(wrist.y || 0);
                        batchDocument.wrist_z.push(wrist.z || 0);
                        
                        // THUMB_TIP (landmark 4)
                        const thumbTip = frame.rawLandmarks[4] || {};
                        batchDocument.thumbTip_x.push(thumbTip.x || 0);
                        batchDocument.thumbTip_y.push(thumbTip.y || 0);
                        batchDocument.thumbTip_z.push(thumbTip.z || 0);
                        
                        // INDEX_TIP (landmark 8)
                        const indexTip = frame.rawLandmarks[8] || {};
                        batchDocument.indexTip_x.push(indexTip.x || 0);
                        batchDocument.indexTip_y.push(indexTip.y || 0);
                        batchDocument.indexTip_z.push(indexTip.z || 0);
                        
                        // MIDDLE_MCP (landmark 9)
                        const middleMcp = frame.rawLandmarks[9] || {};
                        batchDocument.middleMcp_x.push(middleMcp.x || 0);
                        batchDocument.middleMcp_y.push(middleMcp.y || 0);
                        batchDocument.middleMcp_z.push(middleMcp.z || 0);
                    } else {
                        // Fill with zeros if no landmark data
                        ['wrist_x', 'wrist_y', 'wrist_z', 
                         'thumbTip_x', 'thumbTip_y', 'thumbTip_z',
                         'indexTip_x', 'indexTip_y', 'indexTip_z',
                         'middleMcp_x', 'middleMcp_y', 'middleMcp_z'].forEach(key => {
                            batchDocument[key].push(0);
                        });
                    }
                });
                
        
                let retries = 3;
                while (retries > 0) {
                    try {
                        await db.collection("LandmarkBatches").doc(batchDocId).set(batchDocument);
                        savedBatches++;
                        console.log(`✅ Saved batch ${savedBatches} (frames ${batchStart}-${batchEnd-1})`);
                        break;
                    } catch (error) {
                        retries--;
                        console.warn(`⚠️ Batch save failed, ${retries} retries left:`, error.message);
                        if (retries === 0) {
                            console.error(`❌ Failed to save batch after all retries`);
                        } else {
                            // Wait before retry
                            await new Promise(resolve => setTimeout(resolve, 1000 * (4 - retries)));
                        }
                    }
                }
                
                if (batchEnd < totalFrames) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`✅ Optimized landmark saving complete: ${savedBatches} batches saved`);
            
        } catch (error) {
            console.error(`❌ Error in optimized landmark saving:`, error);
        }
    }, 100);
}

document.getElementById('questionnaire-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const responses = {};
    
    // Collect all form data
    for (let [key, value] of formData.entries()) {
        responses[key] = value;
    }
    
    console.log("📋 Questionnaire responses to save:", responses);
    
    const expectedFields = [
        'videogame', 'musical', 'sports', 'caffeine', 
        'mood', 'motivated', 'distracted', 'performance',
        'neurological', 'handPain', 'handInjuryHistory', 'persistence', 'attention', 'competition', 'income', 'zipcode'
    ];
    
    const missingFields = expectedFields.filter(field => !responses[field]);
    if (missingFields.length > 0) {
        console.warn("⚠️ Missing required fields:", missingFields);
        alert(`Please complete all required fields: ${missingFields.join(', ')}`);
        return;
    }
    
    const questionnaireData = {
        experienceRatings: {
            videogameExperience: parseInt(responses.videogame),
            musicalExperience: parseInt(responses.musical),
            sportsExperience: parseInt(responses.sports),
            caffeineIntakeToday: parseInt(responses.caffeine)
        },
        moodPerformanceRatings: {
            currentMood: parseInt(responses.mood),
            taskMotivation: parseInt(responses.motivated),
            taskDistraction: parseInt(responses.distracted),
                persistenceWhenFrustrated: parseInt(responses.persistence),
                attentionSpanGeneral: parseInt(responses.attention),
                enjoymentOfCompetition: parseInt(responses.competition)
        },
        demographics: {
            hasNeurologicalConditions: responses.neurological === 'yes',
            hasHandPain: responses.handPain === 'yes',
            hasHandInjuryHistory: responses.handInjuryHistory === 'yes',
            householdIncome: responses.income,
            zipCode: responses.zipcode
        },
        feedback: responses.feedback || '',
        completedAt: new Date().toISOString(),
        participantID: sessionStorage.getItem('prolificID') || 'anonymous'
    };
    
    console.log("💾 Structured questionnaire data:", questionnaireData);
    
    const participantID = sessionStorage.getItem('prolificID') || 'anonymous';
    
    const savePromises = [];
    
    savePromises.push(
        db.collection("Results")
        .doc(participantID)
        .collection("Questionnaire")
        .doc("Responses")
        .set(questionnaireData)
        .catch(err => {
            console.warn("Failed to save to Results collection:", err);
            return { error: err, location: "Results" };
        })
    );
    
    savePromises.push(
        db.collection("Participants")
        .doc(participantID)
        .collection("Questionnaire")
        .doc("Demographics")
        .set(questionnaireData)
        .catch(err => {
            console.warn("Failed to save to Participants collection:", err);
            return { error: err, location: "Participants" };
        })
    );
    
    savePromises.push(
        db.collection("QuestionnaireResponses")
        .doc(participantID)
        .set(questionnaireData)
        .catch(err => {
            console.warn("Failed to save to QuestionnaireResponses:", err);
            return { error: err, location: "QuestionnaireResponses" };
        })
    );
    
    Promise.allSettled(savePromises)
        .then((results) => {
            let successCount = 0;
            results.forEach((result, index) => {
                if (result.status === 'fulfilled' && !result.value?.error) {
                    successCount++;
                } else {
                    console.warn(`Save ${index} failed:`, result.reason || result.value?.error);
                }
            });
            
            console.log(`✅ Questionnaire saved to ${successCount}/3 locations`);
            
            document.getElementById('questionnaire-overlay').style.display = 'none';
            showFinalResults();
        })
        .catch(err => {
            console.error("❌ Unexpected error in questionnaire saving:", err);
  
            alert("Some data may not have been saved, but your results are ready.");
            document.getElementById('questionnaire-overlay').style.display = 'none';
            showFinalResults();
        });
});
        function restartTrialDueToHandLoss() {

            activeTrialToken++; 
            if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
            if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
            if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }


            if (!recording) return;
            
            recording = false;
            document.getElementById('center-timer').style.display = 'none';

            if (mainTimerInterval) {
                clearInterval(mainTimerInterval);
                mainTimerInterval = null;
            }
            
            lastHandSeenTime = 0;
            lastTapTime = 0;
            startTime = null;
            
            distanceSignal = [];
            timeSignal = [];
            smoothedSignal = [];
            velocitySignal = [];
            tapEvents = [];
            frameCount = 0;
            frameData = [];
            
            document.getElementById('hand-guide-overlay').style.display = 'block';
            document.getElementById('hand-outline').style.display = 'block';
            document.getElementById('tapWidthFeedback').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            
            const overlay = document.getElementById('trial-instructions-overlay');
            const instructionText = document.getElementById('trial-instructions-text');
            
            instructionText.innerHTML = `
                <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Hand Lost</div>
                <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Please keep your hand clearly visible</div>
            `;
                                
            document.querySelector('.trial-overlay-instruction').innerHTML = 
                'Please keep your hand <strong>clearly visible</strong> throughout the test';
            
            overlay.style.display = 'flex';
            
            document.getElementById('center-timer').textContent = '00:10';
      
            
            const positionStatus = document.getElementById('position-status');
            positionStatus.textContent = 'Position hand in view';
            positionStatus.className = 'position-status';
            readyToStart = true;
            preStartTapCount = 0;
            lastPreStartTapTime = 0;
            
            setTimeout(() => {
                if (!handDetected) {
                    updateHandPositionFeedback(null);
                }
            }, 100);
        }

        function restartTrialDueToInactivity() {
            activeTrialToken++; 
            if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
            if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
            if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            

            if (!recording) return;
            
            recording = false;
            document.getElementById('center-timer').style.display = 'none';
            
            if (mainTimerInterval) {
                clearInterval(mainTimerInterval);
                mainTimerInterval = null;
            }
            
            lastHandSeenTime = 0;
            lastTapTime = 0;
            startTime = null;
            
            distanceSignal = [];
            timeSignal = [];
            smoothedSignal = [];
            velocitySignal = [];
            tapEvents = [];
            frameCount = 0;
            frameData = [];

            document.getElementById('hand-guide-overlay').style.display = 'block';
            document.getElementById('hand-outline').style.display = 'block';
            document.getElementById('tapWidthFeedback').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            
            const overlay = document.getElementById('trial-instructions-overlay');
            const instructionText = document.getElementById('trial-instructions-text');
            
            instructionText.innerHTML = `
                <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Trial Paused</div>
                <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Please continue tapping throughout the test</div>
            `;
            
            document.querySelector('.trial-overlay-instruction').innerHTML = 
                'Keep tapping your <strong>thumb and index finger</strong> consistently';
            
            overlay.style.display = 'flex';
            
            document.getElementById('center-timer').textContent = '00:10';
 
            
            const positionStatus = document.getElementById('position-status');
            positionStatus.textContent = 'Position hand in view';
            positionStatus.className = 'position-status';
            readyToStart = true;
            preStartTapCount = 0;
        }

        function restartTrialDueToWrongHand() {
            activeTrialToken++;
            if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
            if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
            if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            

            if (!recording) return;
            
            recording = false;
            document.getElementById('center-timer').style.display = 'none';

            clearInterval(mainTimerInterval);
            
            // Reset UI
            document.getElementById('hand-guide-overlay').style.display = 'block';
            document.getElementById('hand-outline').style.display = 'block';
            document.getElementById('tapWidthFeedback').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            
            // Show restart message
            const overlay = document.getElementById('trial-instructions-overlay');
            const instructionText = document.getElementById('trial-instructions-text');
            const requiredHand = trialConditions[trialIndex % trialConditions.length].hand.toUpperCase();
            
            instructionText.innerHTML = `
                <div style="color: #ef4444; font-size: 2.8rem; margin-bottom: 1rem;">Wrong Hand!</div>
                <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Please use your ${requiredHand} hand</div>
            `;
            
            document.querySelector('.trial-overlay-instruction').innerHTML = 
                `Please tap with your <strong>${requiredHand}</strong> hand only`;
            
            overlay.style.display = 'flex';
            
            document.getElementById('center-timer').textContent = '00:10';
     
            const positionStatus = document.getElementById('position-status');
            positionStatus.textContent = 'Position hand in view';
            positionStatus.className = 'position-status';
            readyToStart = true;
            preStartTapCount = 0;
        }
        function calculateClinicalAssessment() {
            const tapCount = tapEvents.length;
            const intervals = [];
            const amplitudes = [];
            
            for (let i = 1; i < tapEvents.length; i++) {
                intervals.push(tapEvents[i].time - tapEvents[i-1].time);
            }
            
            for (let i = 0; i < tapEvents.length - 1; i++) {
                const startIdx = tapEvents[i].index;
                const endIdx = tapEvents[i+1].index;
                let maxAmp = 0;
                for (let j = startIdx; j < endIdx && j < smoothedSignal.length; j++) {
                    maxAmp = Math.max(maxAmp, smoothedSignal[j]);
                }
                amplitudes.push(maxAmp);
            }
            
            const avgFrequency = intervals.length > 0 ? 1000 / (intervals.reduce((a, b) => a + b, 0) / intervals.length) : 0;
            const avgAmplitude = amplitudes.length > 0 ? amplitudes.reduce((a, b) => a + b, 0) / amplitudes.length : 0;
            
            let amplitudeDecrement = 0;
            if (amplitudes.length >= 3) {
                const firstThird = amplitudes.slice(0, Math.floor(amplitudes.length / 3));
                const lastThird = amplitudes.slice(-Math.floor(amplitudes.length / 3));
                const firstAvg = firstThird.reduce((a, b) => a + b, 0) / firstThird.length;
                const lastAvg = lastThird.reduce((a, b) => a + b, 0) / lastThird.length;
                amplitudeDecrement = ((firstAvg - lastAvg) / firstAvg) * 100;
            }
            
            let rhythmCV = 0;
            if (intervals.length > 0) {
                const mean = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const variance = intervals.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / intervals.length;
                rhythmCV = (Math.sqrt(variance) / mean) * 100;
            }
            
            const hesitations = intervals.filter(i => i > 500 && i < 1000).length;
            const freezing = intervals.filter(i => i >= 1000).length;
            const speedAmplitudeIndex = avgFrequency * (avgAmplitude / 100);
            
            let score = 0;
            let details = [];
            
            if (avgFrequency < 1.25) {
                score = Math.max(score, 3);
                details.push("Severe slowing (<1.25 Hz)");
            } else if (avgFrequency < 2.0) {
                score = Math.max(score, 2);
                details.push("Moderate slowing (1.25–2.0 Hz)");
            } else if (avgFrequency < 2.5) {
                score = Math.max(score, 1);
                details.push("Slight slowing (2.0–2.5 Hz)");
            }

            if (avgAmplitude < 20) {
                score = Math.max(score, 2);
                details.push("Small amplitude movements");
            }
            
            if (amplitudeDecrement > 50) {
                score = Math.max(score, 3);
                details.push("Severe amplitude decrement");
            } else if (amplitudeDecrement > 30) {
                score = Math.max(score, 2);
                details.push("Amplitude decrements midway");
            } else if (amplitudeDecrement > 15) {
                score = Math.max(score, 1);
                details.push("Amplitude decrements near the end");
            }

            if (freezing > 0) {
                score = Math.max(score, 3);
                details.push(`${freezing} freezing episode(s)`);
            } else if (hesitations >= 5) {
                score = Math.max(score, 3);
                details.push("More than 5 interruptions");
            } else if (hesitations >= 3) {
                score = Math.max(score, 2);
                details.push("3-5 interruptions");
            } else if (hesitations >= 1) {
                score = Math.max(score, 1);
                details.push("1-2 interruptions");
            }
            
            if (rhythmCV > 40) {
                score = Math.max(score, 2);
                details.push("Significant rhythm irregularity");
            } else if (rhythmCV > 25) {
                score = Math.max(score, 1);
                details.push("Mild rhythm irregularity");
            }
            
            return {
                score: score,
                details: details,
                metrics: {
                    tapCount: tapCount,
                    avgFrequency: avgFrequency,
                    avgAmplitude: avgAmplitude,
                    amplitudeDecrement: amplitudeDecrement,
                    rhythmCV: rhythmCV,
                    hesitations: hesitations,
                    freezing: freezing,
                    speedAmplitudeIndex: speedAmplitudeIndex,
                    testDuration: (timeSignal[timeSignal.length - 1] || 0) / 1000,
                    signalQuality: {
                        framesProcessed: frameCount,
                        samplingRate: frameCount / ((timeSignal[timeSignal.length - 1] || 1) / 1000),
                        detectionsConfidence: tapEvents.length / (frameCount / 30)
                    }
                }
            };
        }
        
        function showInsufficientTapsRestart() {
            activeTrialToken++; 
            if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
            if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
            if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }


            recording = false;
            document.getElementById('center-timer').style.display = 'none';
            

            if (mainTimerInterval) {
                clearInterval(mainTimerInterval);
                mainTimerInterval = null;
            }
            lastHandSeenTime = 0;
            lastTapTime = 0;
            startTime = null;
            
            distanceSignal = [];
            timeSignal = [];
            smoothedSignal = [];
            velocitySignal = [];
            tapEvents = [];
            frameCount = 0;
            frameData = [];
            
            document.getElementById('hand-guide-overlay').style.display = 'block';
            document.getElementById('hand-outline').style.display = 'block';
            document.getElementById('tapWidthFeedback').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            
            // Show restart message
            const overlay = document.getElementById('trial-instructions-overlay');
            const instructionText = document.getElementById('trial-instructions-text');
            
            instructionText.innerHTML = `
                <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Too Few Taps</div>
                <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Please tap more frequently during the test</div>
            `;
            
            document.querySelector('.trial-overlay-instruction').innerHTML = 
                'Please tap your <strong>thumb and index finger</strong> continuously and rapidly';
            
            overlay.style.display = 'flex';
            
            document.getElementById('center-timer').textContent = '00:10';

            
            const positionStatus = document.getElementById('position-status');
            positionStatus.textContent = 'Position hand in view';
            positionStatus.className = 'position-status';
            readyToStart = true;
            preStartTapCount = 0;
        }


        
  function updateConditionUI() {
    const trialNum = trialIndex + 1;
    const condition = trialConditions[trialIndex % trialConditions.length];
    const handText = condition.hand.charAt(0).toUpperCase() + condition.hand.slice(1);
    const total = totalTrials;
    
    window.handPositionCorrect = false;
    readyToStart = true;
    preStartTapCount = 0;
    lastPreStartTapTime = 0;
    
    window.preStartDistanceSignal = [];
    window.preStartTimeSignal = [];
  
    handLabelBuffer = [];
    currentDetectedHand = null;
    if (condition.hand === 'left') {
        document.body.classList.add('layout-left-hand');
        document.body.classList.remove('layout-right-hand');
    } else {
        document.body.classList.add('layout-right-hand');
        document.body.classList.remove('layout-left-hand');
    }
    
    const handGuide = document.getElementById('hand-guide-overlay');
    handGuide.style.display = 'block';
    document.getElementById('hand-outline').style.display = 'block';
    
    let totalTapsDisplay = '';
    if (trialIndex > 0 && allTrialResults.length > 0) {
        const lastTrialTaps = allTrialResults[allTrialResults.length - 1].result.metrics.tapCount;
        const lastTrialHand = allTrialResults[allTrialResults.length - 1].condition.hand;
        totalTapsDisplay = `
            <div style="font-size: 2rem; color: #3b82f6; font-weight: 400; margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.08); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.15);">
                Previous trial (${lastTrialHand} hand): <span style="font-weight: 700;">${lastTrialTaps} taps</span>
            </div>
            <div style="font-size: 2.4rem; color: #22c55e; font-weight: 300; margin-bottom: 2rem; padding: 1.5rem; background: rgba(34, 197, 94, 0.08); border-radius: 16px; border: 1px solid rgba(34, 197, 94, 0.15); letter-spacing: -0.01em;">
                Total so far: <span style="font-weight: 700;">${totalTapsAcrossAllTrials} taps</span>
            </div>
        `;
    }
    const instructionHTML = `${totalTapsDisplay}Trial ${trialNum} of ${total}<br><span style="font-size: 1.8rem; margin-top: 1rem; display: block;">Use your <strong>${handText.toUpperCase()}</strong> hand</span>`;
    document.getElementById('trial-instructions-text').innerHTML = instructionHTML;
    document.getElementById('trial-instructions-overlay').style.display = 'flex';
    
    const beginInstruction = document.getElementById('begin-instruction');


    if (window.innerWidth <= 768 || isIPad()) {
        beginInstruction.textContent = 'Tap here to begin';
    } else {
        beginInstruction.textContent = 'Click to begin';
    }

    document.getElementById('trial-number').textContent = `Trial ${trialNum} of ${total}`;
    document.getElementById('hand-instruction').textContent = `${handText} Hand`;
    
    document.getElementById('center-timer').textContent = '00:10';
 
    
    const positionStatus = document.getElementById('position-status');
    positionStatus.textContent = 'Position hand in view';
    positionStatus.className = 'position-status';
  }
 function analyzeAllTrials() {
            showQuestionnaire();
}


function showFinalResults() {
    document.getElementById('finalResults').style.display = 'block';
    document.body.classList.add('results-page');
    
    let rightTrials = allTrialResults.filter(t => t.condition.hand === 'right');
    let leftTrials = allTrialResults.filter(t => t.condition.hand === 'left');

    const calculateAverage = (trials, metric) => {
        const values = trials.map(t => t.result.metrics[metric]);
        return values.reduce((a, b) => a + b, 0) / values.length;
    };
    
    const rightFastFreq = calculateAverage(rightTrials, 'avgFrequency');
    const leftFastFreq = calculateAverage(leftTrials, 'avgFrequency');
    const avgFastFreq = (rightFastFreq + leftFastFreq) / 2;

    const avgTapsPerTenSec = avgFastFreq * 10;
     
    const populationMean = 5.14;
    const populationSD = 1.31;   
    const userTapsPerSec = avgFastFreq; 
    const zScore = (userTapsPerSec - populationMean) / populationSD;
    
    function normalCDF(z) {
        return 0.5 * (1 + erf(z / Math.sqrt(2)));
    }
    const percentile = Math.round(normalCDF(zScore) * 100);

    
    function getOrdinalSuffix(num) {
        if (num % 100 >= 11 && num % 100 <= 13) return num + 'th';
        switch (num % 10) {
            case 1: return num + 'st';
            case 2: return num + 'nd';
            case 3: return num + 'rd';
            default: return num + 'th';
        }
    }


    
    let percentileText;
    if (percentile >= 95) percentileText = "exceptional";
    else if (percentile >= 85) percentileText = "well above average";
    else if (percentile >= 70) percentileText = "above average";
    else if (percentile >= 30) percentileText = "average range";
    else if (percentile >= 15) percentileText = "below average";
    else percentileText = "well below average";
    const rightTapsPerRound = Math.round(calculateAverage(rightTrials, 'tapCount'));
    const leftTapsPerRound = Math.round(calculateAverage(leftTrials, 'tapCount'));
    
    const participantID = sessionStorage.getItem('prolificID') || '';
    const isFromProlific = participantID && !participantID.startsWith('anon_');
    const prolificCode = "CXXRL3ML";
    
    const isMobile = window.innerWidth <= 768;
    
    let html = `
        <div style="max-width: 1000px; margin: 0 auto; padding: ${isMobile ? '2rem 1rem' : '3rem 3rem'}; text-align: center; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div style="margin-bottom: ${isMobile ? '3rem' : '4rem'};">
                <p style="font-size: ${isMobile ? 'clamp(1.4rem, 4vw, 2.2rem)' : '3.4rem'}; color: #1a1a1a; line-height: ${isMobile ? '1.4' : '1.3'}; margin-bottom: ${isMobile ? '2rem' : '4rem'}; font-weight: 300; letter-spacing: -0.02em;">
                    You tapped <strong style="font-weight: 700; ${isMobile ? 'color: #22c55e; font-size: 1.1em;' : ''}">${rightTapsPerRound}</strong> times per round (10s) with your <strong style="font-weight: 700;">right hand</strong>${isMobile ? '<br>' : ' and<br>'}
                    <strong style="font-weight: 700; ${isMobile ? 'color: #22c55e; font-size: 1.1em;' : ''}">${leftTapsPerRound}</strong> times per round with your <strong style="font-weight: 700;">left hand</strong>.
                </p>
            </div>`;


    html += `
    <div style="background: rgba(59, 130, 246, 0.08); border-radius: 16px; padding: ${isMobile ? '1.5rem' : '2rem'}; margin-bottom: ${isMobile ? '2rem' : '3rem'}; border: 1px solid rgba(59, 130, 246, 0.15);">
        <p style="font-size: ${isMobile ? '1.2rem' : '1.6rem'}; color: #1a1a1a; margin-bottom: 0.5rem; font-weight: 500;">Population Comparison</p>
        <p style="font-size: ${isMobile ? '1.8rem' : '2.2rem'}; color: #3b82f6; font-weight: 700; margin-bottom: 0.5rem;">${getOrdinalSuffix(percentile)} percentile</p>
        <p style="font-size: ${isMobile ? '1rem' : '1.2rem'}; color: #666666; margin: 0;">Your speed is ${percentileText} (${userTapsPerSec.toFixed(1)} taps/sec vs ${populationMean} average)</p>
    </div>`;
    
    if (isFromProlific) {
        html += `
            <div class="${isMobile ? 'mobile-prolific-code' : ''}" style="${isMobile ? '' : 'background: rgba(34, 197, 94, 0.1); border: 2px solid #22c55e; border-radius: 16px; padding: 2rem; margin-bottom: 3rem;'}">
                <p style="font-size: ${isMobile ? '1.3rem' : '1.6rem'}; color: #1a1a1a; margin-bottom: 1rem; font-weight: 500;">Prolific Completion Code:</p>
                <p style="font-size: ${isMobile ? '2.2rem' : '2.8rem'}; color: #22c55e; font-weight: 700; letter-spacing: 0.1em; font-family: 'Courier New', monospace;">${prolificCode}</p>
                <p style="font-size: ${isMobile ? '1rem' : '1.2rem'}; color: #666666; margin-top: 1rem;">Please copy this code and paste it into Prolific to complete your participation.</p>
            </div>`;
    }
            
    html += `
                <div class="${isMobile ? 'mobile-button-container' : ''}" style="${isMobile ? '' : 'display: flex; gap: 2rem; justify-content: center;'}">
                    <button onclick="shareResults()" style="background-color: transparent; color: #000000; border: 2px solid #000000; padding: ${isMobile ? '1.25rem 2rem' : '1.5rem 3rem'}; font-size: ${isMobile ? '1.2rem' : '1.3rem'}; font-weight: 500; border-radius: ${isMobile ? '12px' : '60px'}; cursor: pointer; transition: all 0.2s ease; font-family: 'Inter', sans-serif; ${isMobile ? 'width: 100%;' : ''}">
                        Share Results
                    </button>
                </div>
            </div>
        `;
    
                    
    document.getElementById('finalResults').innerHTML = html;

    // Save final summary to database
    const finalParticipantID = participantID || 'anonymous';

    allTrialResults.forEach((trial, index) => {
        const trialNum = `Trial ${index + 1}`;
        const metrics = trial.result.metrics;

        db.collection("Results")
            .doc(finalParticipantID)
            .collection("Trials")
            .doc(trialNum)
            .set({
                condition: trial.condition,
                repetition: trial.repetition,
                ...metrics,
                score: trial.result.score,
                details: trial.result.details,
                timestamp: new Date().toISOString()
            });
    });

    db.collection("Results")
    .doc(finalParticipantID)
    .collection("Summary")
    .doc("FinalSummary")
    .set({
        completedAt: new Date().toISOString(),
        totalTrials: allTrialResults.length,
        prolificCompletionCode: isFromProlific ? prolificCode : null,
        isFromProlific: isFromProlific,
        finalAverages: {
            tappingFrequency: avgFastFreq,
            tapsPerTenSeconds: avgTapsPerTenSec
        },
        allTrialMetrics: allTrialResults.map((t, idx) => ({
            trialNum: idx + 1,
            condition: t.condition,
            ...t.result.metrics
        }))
    })
    .then(() => console.log("Final summary saved for", finalParticipantID))
    .catch(err => console.error("Error saving final summary:", err));
}
        // Social media share functions
        function shareResults() {
            const rightTrials = allTrialResults.filter(t => t.condition.hand === 'right');
            const leftTrials = allTrialResults.filter(t => t.condition.hand === 'left');
            const calculateAverage = (trials, metric) => {
                const values = trials.map(t => t.result.metrics[metric]);
                return values.reduce((a, b) => a + b, 0) / values.length;
            };
            
            const rightTapsPerRound = Math.round(calculateAverage(rightTrials, 'tapCount'));
            const leftTapsPerRound = Math.round(calculateAverage(leftTrials, 'tapCount'));
            const rightFastFreq = calculateAverage(rightTrials, 'avgFrequency');
            const leftFastFreq = calculateAverage(leftTrials, 'avgFrequency');


            
            showShareOptions(rightTapsPerRound, leftTapsPerRound);
        }
        
        function showShareOptions(rightTaps, leftTaps) {
            const rightTrials = allTrialResults.filter(t => t.condition.hand === 'right');
            const leftTrials = allTrialResults.filter(t => t.condition.hand === 'left');
            const calculateAverage = (trials, metric) => {
                const values = trials.map(t => t.result.metrics[metric]);
                return values.reduce((a, b) => a + b, 0) / values.length;
            };
            const rightFastFreq = calculateAverage(rightTrials, 'avgFrequency');
            const leftFastFreq = calculateAverage(leftTrials, 'avgFrequency');
            const avgFastFreq = (rightFastFreq + leftFastFreq) / 2;
            const populationMean = 5.14;
            const populationSD = 1.31;
            const userTapsPerSec = avgFastFreq;
            const zScore = (userTapsPerSec - populationMean) / populationSD;
            function normalCDF(z) {
                return 0.5 * (1 + erf(z / Math.sqrt(2)));
            }
            const percentile = Math.round(normalCDF(zScore) * 100);
            
            const shareText = `Test your finger tapping speed at actioncensus.org\n\nMy results:\nRight: ${rightTaps} taps/10sec\nLeft: ${leftTaps} taps/10sec\nSpeed: ${userTapsPerSec.toFixed(1)} taps/sec (${percentile}th percentile)`;


            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 3rem; max-width: 500px; width: 90%; text-align: center; font-family: 'Inter', sans-serif;">
                    <h3 style="font-size: 2rem; margin-bottom: 2rem; color: #1a1a1a;">Share Your Results</h3>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                        <button onclick="shareToTwitter(\`${shareText}\`)" style="background: #1da1f2; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                            Share on Twitter
                        </button>
                        
                        <button onclick="shareToFacebook(\`${shareText}\`)" style="background: #4267B2; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            Share on Facebook
                        </button>
                        
                        <button onclick="shareToBluesky(\`${shareText}\`)" style="background: #00a8e8; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.27-.04.40-.056-.15.04-.297.083-.445.124-2.670.739-5.568 1.663-6.383 4.4C.378 18.944 0 23.31 0 24c0 .687.139 1.86.902 2.202.659.3 1.664.622 3.3-.237 2.752-1.944 5.711-5.883 6.798-7.995C12.087 20.084 15.046 24.023 17.798 25.965c1.636.859 2.641.537 3.3.237C21.861 25.859 22 24.687 22 24c0-.69-.378-5.65-.624-6.479-.815-2.737-3.713-3.661-6.383-3.4-.148-.041-.295-.084-.445-.124.13.016.264.036.4.056 2.67.296 5.568-.628 6.383-3.364C21.622 9.418 22 5.458 22 4.768c0-.688-.139-1.86-.902-2.203-.659-.299-1.664-.621-3.3.238-2.752 1.942-5.711 5.881-6.798 7.995z"/></svg>
                            Share on Bluesky
                        </button>
                        
                        <button onclick="shareToLinkedIn(\`${shareText}\`)" style="background: #0077b5; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                            Share on LinkedIn
                        </button>
                        
                        <button onclick="copyToClipboard(\`${shareText}\`); closeShareModal();" style="background: #6b7280; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            Copy to Clipboard
                        </button>
                    </div>
                    
                    <button onclick="closeShareModal()" style="background: #f3f4f6; color: #374151; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentShareModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeShareModal();
            });
        }
           function shareToTwitter(text) {
            const targetUrl = 'https://shadowcoder1.github.io/pd-video-analyzer';
            const fullText = text + '\n\n' + targetUrl;
            const encodedText = encodeURIComponent(fullText);
            window.open(`https://twitter.com/intent/tweet?text=${encodedText}`, '_blank');
            closeShareModal();
        }
        
        function shareToFacebook(text) {
            const targetUrl = 'https://shadowcoder1.github.io/pd-video-analyzer';
            const encodedUrl = encodeURIComponent(targetUrl);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`, '_blank');
            closeShareModal();
        }
        
        function shareToBluesky(text) {
            const targetUrl = 'https://shadowcoder1.github.io/pd-video-analyzer';
            const fullText = text + '\n\n' + targetUrl;
            const encodedText = encodeURIComponent(fullText);
            window.open(`https://bsky.app/intent/compose?text=${encodedText}`, '_blank');
            closeShareModal();
        }
        
        function shareToLinkedIn(text) {
            const targetUrl = 'https://shadowcoder1.github.io/pd-video-analyzer';
            const title = 'Motor Speed Assessment Results';
            const summary = text.replace(/\n/g, ' ').replace(/👆|⚡|🧠/g, ''); 
            
            const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(targetUrl)}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(summary)}`;
            window.open(linkedInUrl, '_blank');
            closeShareModal();
        }
        
        function copyToClipboard(text) {
            const targetUrl = 'https://shadowcoder1.github.io/pd-video-analyzer';
            const fullText = text + '\n\n' + targetUrl;
            navigator.clipboard.writeText(fullText).then(() => {
                alert('Results copied to clipboard!');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = fullText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Results copied to clipboard!');
            });
        }
        function closeShareModal() {
            if (window.currentShareModal) {
                document.body.removeChild(window.currentShareModal);
                window.currentShareModal = null;
            }
        }
        
        function erf(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            return sign * y;
        }
        let overlayJustDismissed = false;
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' || e.key === ' ') {
                e.preventDefault();
                return; 
            }
        });
        

        document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing...');
                    showMobileLoading();
  
            document.getElementById('page-webcam').style.display = 'block';
            
            try {
                initializeHands();
                initializeCamera();
            } catch (error) {
                console.error('MediaPipe initialization failed:', error);
                alert('Camera initialization failed. Please refresh the page and ensure camera permissions are granted.');
            }
            
            updateConditionUI();

            const beginInstruction = document.getElementById('begin-instruction');
            if (beginInstruction) {
                beginInstruction.addEventListener('click', function(e) {
                    e.preventDefault();
                    const overlay = document.getElementById('trial-instructions-overlay');
                    if (overlay.style.display === 'flex') {
                        overlay.style.display = 'none';
                    }
                });
            }
            
        });
        function restartTrialMobileSafe(reason) {
            activeTrialToken++; 
            if (mainTimerInterval) { clearInterval(mainTimerInterval); mainTimerInterval = null; }
            if (inactivityInterval) { clearInterval(inactivityInterval); inactivityInterval = null; }
            if (stopTimeoutId) { clearTimeout(stopTimeoutId); stopTimeoutId = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }


            if (!recording) return;
            
            recording = false;
            clearInterval(mainTimerInterval);
            
            lastHandSeenTime = 0;
            
            document.getElementById('hand-guide-overlay').style.display = 'block';
            document.getElementById('hand-outline').style.display = 'block';
            document.getElementById('tapWidthFeedback').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            
            // FIXED: Mbile-safe restart messaging
            if (window.innerWidth <= 768) {
                const positionStatus = document.getElementById('position-status');
                switch(reason) {
                    case 'handLoss':
                        positionStatus.textContent = 'Keep hand visible - tap to retry';
                        break;
                    case 'inactivity':
                        positionStatus.textContent = 'Keep tapping - tap to retry';
                        break;
                    case 'fewTaps':
                        positionStatus.textContent = 'Tap faster - tap to retry';
                        break;
                    default:
                        positionStatus.textContent = 'Tap to retry trial';
                }
                positionStatus.className = 'position-status warning';
                
                positionStatus.style.cursor = 'pointer';
                positionStatus.onclick = () => {
                    positionStatus.onclick = null;
                    positionStatus.style.cursor = '';
                    startRecording();
                };
            } else {
                const overlay = document.getElementById('trial-instructions-overlay');
                const instructionText = document.getElementById('trial-instructions-text');
                
                switch(reason) {
                    case 'handLoss':
                        instructionText.innerHTML = `
                            <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Hand Lost</div>
                            <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Keep hand visible during test</div>
                        `;
                        break;
                    case 'inactivity':
                        instructionText.innerHTML = `
                            <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Trial Paused</div>
                            <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Continue tapping throughout</div>
                        `;
                        break;
                    case 'fewTaps':
                        instructionText.innerHTML = `
                            <div style="color: #f59e0b; font-size: 2.8rem; margin-bottom: 1rem;">Too Few Taps</div>
                            <div style="color: #1a1a1a; font-size: 1.8rem; font-weight: 400;">Tap more frequently</div>
                        `;
                        break;
                }
                
                overlay.style.display = 'flex';
            }
            
            // Reset displays
            document.getElementById('center-timer').textContent = '00:10';

        }
            
    </script>
</body>
</html>
