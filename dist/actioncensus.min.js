!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.ActionCensus=e():t.ActionCensus=e()}(this,()=>{return t={805:function(t,e,n){var i,a,r;function o(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var o=i&&i.prototype instanceof h?i:h,l=Object.create(o.prototype);return s(l,"_invoke",function(n,i,a){var r,o,s,h=0,l=a||[],u=!1,d={p:0,n:0,v:t,a:f,f:f.bind(t,4),d:function(e,n){return r=e,o=0,s=t,d.n=n,c}};function f(n,i){for(o=n,s=i,e=0;!u&&h&&!a&&e<l.length;e++){var a,r=l[e],f=d.p,m=r[2];n>3?(a=m===i)&&(s=r[(o=r[4])?5:(o=3,3)],r[4]=r[5]=t):r[0]<=f&&((a=n<2&&f<r[1])?(o=0,d.v=i,d.n=r[1]):f<m&&(a=n<3||r[0]>i||i>m)&&(r[4]=n,r[5]=i,d.n=m,o=0))}if(a||n>1)return c;throw u=!0,i}return function(a,l,m){if(h>1)throw TypeError("Generator is already running");for(u&&1===l&&f(l,m),o=l,s=m;(e=o<2?t:s)||!u;){r||(o?o<3?(o>1&&(d.n=-1),f(o,s)):d.n=s:d.v=s);try{if(h=2,r){if(o||(a="next"),e=r[a]){if(!(e=e.call(r,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,o<2&&(o=0)}else 1===o&&(e=r.return)&&e.call(r),o<2&&(s=TypeError("The iterator does not provide a '"+a+"' method"),o=1);r=t}else if((e=(u=d.n<0)?s:n.call(i,d))!==c)break}catch(e){r=t,o=1,s=e}finally{h=1}}return{value:e,done:u}}}(n,a,r),!0),l}var c={};function h(){}function l(){}function u(){}e=Object.getPrototypeOf;var d=[][i]?e(e([][i]())):(s(e={},i,function(){return this}),e),f=u.prototype=h.prototype=Object.create(d);function m(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,s(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=u,s(f,"constructor",u),s(u,"constructor",l),l.displayName="GeneratorFunction",s(u,a,"GeneratorFunction"),s(f),s(f,a,"Generator"),s(f,i,function(){return this}),s(f,"toString",function(){return"[object Generator]"}),(o=function(){return{w:r,m}})()}function s(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}s=function(t,e,n,i){function r(e,n){s(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},s(t,e,n,i)}function c(t,e,n,i,a,r,o){try{var s=t[r](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(i,a)}function h(t){return function(){var e=this,n=arguments;return new Promise(function(i,a){var r=t.apply(e,n);function o(t){c(r,i,a,o,s,"next",t)}function s(t){c(r,i,a,o,s,"throw",t)}o(void 0)})}}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach(function(e){d(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function d(t,e,n){return(e=m(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function f(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,m(i.key),i)}}function m(t){var e=function(t,e){if("object"!=v(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=v(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==v(e)?e:e+""}function v(t){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v(t)}r=function(){"use strict";var t={trialDuration:1e4,minRequiredTaps:15,smoothingWindow:3,minPeakDistance:30,closedThreshold:30,openThreshold:35,maxHandLossTime:3e3,maxInactivityTime:5e3,videoWidth:1280,videoHeight:720,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.7},e=0,n=4,i=8,a=9,r=function(){return r=function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.config=u(u({},t),n),this.initialized=!1,this.recording=!1,this.hands=null,this.camera=null,this.videoElement=null,this.canvasElement=null,this.canvasCtx=null,this.distanceSignal=[],this.timeSignal=[],this.smoothedSignal=[],this.velocitySignal=[],this.tapEvents=[],this.frameData=[],this.startTime=null,this.onInit=n.onInit||function(){},this.onStart=n.onStart||function(){},this.onTapDetected=n.onTapDetected||function(){},this.onComplete=n.onComplete||function(){},this.onError=n.onError||function(t){return console.error(t)},this.onHandLost=n.onHandLost||function(){},this.onHandFound=n.onHandFound||function(){}},s=[{key:"init",value:(v=h(o().m(function t(){var e;return o().w(function(t){for(;;)switch(t.p=t.n){case 0:if(t.p=0,"undefined"!=typeof Hands){t.n=1;break}throw new Error("MediaPipe Hands library not loaded. Please include: https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js");case 1:return this.videoElement||(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("playsinline","")),this.canvasElement||(this.canvasElement=document.createElement("canvas")),this.canvasCtx=this.canvasElement.getContext("2d"),this.hands=new Hands({locateFile:function(t){return"https://cdn.jsdelivr.net/npm/@mediapipe/hands/".concat(t)}}),this.hands.setOptions({maxNumHands:1,modelComplexity:this.config.modelComplexity,minDetectionConfidence:this.config.minDetectionConfidence,minTrackingConfidence:this.config.minTrackingConfidence}),this.hands.onResults(this._onHandsResults.bind(this)),t.n=2,this._initCamera();case 2:return this.initialized=!0,this.onInit(),t.a(2,{success:!0});case 3:return t.p=3,e=t.v,this.onError(e),t.a(2,{success:!1,error:e.message})}},t,this,[[0,3]])})),function(){return v.apply(this,arguments)})},{key:"startTrial",value:(m=h(o().m(function t(){var e,n=this,i=arguments;return o().w(function(t){for(;;)switch(t.n){case 0:if(e=i.length>0&&void 0!==i[0]?i[0]:"right",this.initialized){t.n=1;break}throw new Error("ActionCensus not initialized. Call init() first.");case 1:if(!this.recording){t.n=2;break}throw new Error("Trial already in progress.");case 2:return this._resetTrialData(),this.recording=!0,this.startTime=Date.now(),this.currentHand=e.toLowerCase(),this.onStart({hand:e}),setTimeout(function(){n.recording&&n.stopTrial()},this.config.trialDuration),t.a(2,{success:!0})}},t,this)})),function(){return m.apply(this,arguments)})},{key:"stopTrial",value:function(){if(!this.recording)return{success:!1,error:"No trial in progress"};this.recording=!1;var t=this._calculateResults();return this.onComplete(t),t}},{key:"getElements",value:function(){return{video:this.videoElement,canvas:this.canvasElement}}},{key:"destroy",value:(d=h(o().m(function t(){return o().w(function(t){for(;;)switch(t.n){case 0:this.camera&&this.camera.stop(),this.hands&&this.hands.close(),this.videoElement&&this.videoElement.srcObject&&this.videoElement.srcObject.getTracks().forEach(function(t){return t.stop()}),this.initialized=!1;case 1:return t.a(2)}},t,this)})),function(){return d.apply(this,arguments)})},{key:"_initCamera",value:(l=h(o().m(function t(){var e,n,i=this;return o().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,navigator.mediaDevices.getUserMedia({video:{width:{ideal:this.config.videoWidth},height:{ideal:this.config.videoHeight},facingMode:"user"}});case 1:return e=t.v,this.videoElement.srcObject=e,t.a(2,new Promise(function(t){i.videoElement.onloadedmetadata=function(){i.canvasElement.width=i.videoElement.videoWidth,i.canvasElement.height=i.videoElement.videoHeight,i._startProcessing(),t()}}));case 2:throw t.p=2,n=t.v,new Error("Camera access denied: ".concat(n.message));case 3:return t.a(2)}},t,this,[[0,2]])})),function(){return l.apply(this,arguments)})},{key:"_startProcessing",value:function(){var t=this,e=function(){var n=h(o().m(function n(){return o().w(function(n){for(;;)switch(n.n){case 0:if(!(t.videoElement.readyState>=2)){n.n=1;break}return n.n=1,t.hands.send({image:t.videoElement});case 1:requestAnimationFrame(e);case 2:return n.a(2)}},n)}));return function(){return n.apply(this,arguments)}}();requestAnimationFrame(e)}},{key:"_onHandsResults",value:function(t){if(this.canvasCtx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.canvasCtx.drawImage(t.image,0,0,this.canvasElement.width,this.canvasElement.height),t.multiHandLandmarks&&t.multiHandLandmarks.length>0){var e=t.multiHandLandmarks[0];this.onHandFound(),this.recording&&this._processFrame(e,t.image.width,t.image.height),this._drawHandVisualization(e)}else this.onHandLost()}},{key:"_processFrame",value:function(t,r,o){var s=Date.now()-this.startTime,c=t[e],h=t[a],l=Math.sqrt(Math.pow((c.x-h.x)*r,2)+Math.pow((c.y-h.y)*o,2)),u=t[n],d=t[i],f=Math.sqrt(Math.pow((u.x-d.x)*r,2)+Math.pow((u.y-d.y)*o,2)+Math.pow((u.z-d.z)*r*.5,2))/l*100;this.distanceSignal.push(f),this.timeSignal.push(s),this.distanceSignal.length>=this.config.smoothingWindow&&(this.smoothedSignal=this._movingAverage(this.distanceSignal,this.config.smoothingWindow),this.smoothedSignal.length>1&&(this.velocitySignal=this._calculateDerivative(this.smoothedSignal,this.timeSignal),this._detectTaps())),this.frameData.push({timestamp:s,normalizedDistance:f,handSize:l,thumbTip:{x:u.x,y:u.y,z:u.z},indexTip:{x:d.x,y:d.y,z:d.z}})}},{key:"_detectTaps",value:function(){for(var t=[],e=new Set,n=1;n<this.distanceSignal.length;n++)if(this.distanceSignal[n]-this.distanceSignal[n-1]<-3&&!e.has(n)){var i=this.timeSignal[n];i-(t.length>0?t[t.length-1].time:-1e3)>this.config.minPeakDistance&&(t.push({index:n,time:i,amplitude:this.distanceSignal[n]}),e.add(n))}for(var a=2;a<this.distanceSignal.length-2;a++){var r=this.distanceSignal[a];if(r<this.distanceSignal[a-1]&&r<this.distanceSignal[a-2]&&r<=this.distanceSignal[a+1]&&r<=this.distanceSignal[a+2]&&r<this.config.closedThreshold&&!e.has(a)){var o=this.timeSignal[a];o-(t.length>0?t[t.length-1].time:-1e3)>this.config.minPeakDistance&&(t.push({index:a,time:o,amplitude:r}),e.add(a))}}t.sort(function(t,e){return t.time-e.time}),this.tapEvents=[];for(var s=0,c=t;s<c.length;s++){var h=c[s];(0===this.tapEvents.length||h.time-this.tapEvents[this.tapEvents.length-1].time>=this.config.minPeakDistance)&&(this.tapEvents.push(h),this.onTapDetected(h))}}},{key:"_movingAverage",value:function(t,e){for(var n=[],i=0;i<t.length;i++){for(var a=Math.max(0,i-Math.floor(e/2)),r=Math.min(t.length,i+Math.floor(e/2)+1),o=0,s=a;s<r;s++)o+=t[s];n.push(o/(r-a))}return n}},{key:"_calculateDerivative",value:function(t,e){for(var n=[],i=1;i<t.length;i++){var a=(e[i]-e[i-1])/1e3,r=t[i]-t[i-1];n.push(r/a)}return n}},{key:"_calculateResults",value:function(){for(var t=[],e=[],n=1;n<this.tapEvents.length;n++)t.push(this.tapEvents[n].time-this.tapEvents[n-1].time);for(var i=0;i<this.tapEvents.length-1;i++){for(var a=this.tapEvents[i].index,r=this.tapEvents[i+1].index,o=0,s=a;s<r&&s<this.smoothedSignal.length;s++)o=Math.max(o,this.smoothedSignal[s]);e.push(o)}var c=t.length>0?1e3/(t.reduce(function(t,e){return t+e},0)/t.length):0,h=e.length>0?e.reduce(function(t,e){return t+e},0)/e.length:0,l=0;if(t.length>0){var u=t.reduce(function(t,e){return t+e},0)/t.length,d=t.reduce(function(t,e){return t+Math.pow(e-u,2)},0)/t.length;l=Math.sqrt(d)/u*100}var f=0;if(e.length>=3){var m=e.slice(0,Math.floor(e.length/3)),v=e.slice(-Math.floor(e.length/3)),p=m.reduce(function(t,e){return t+e},0)/m.length;f=(p-v.reduce(function(t,e){return t+e},0)/v.length)/p*100}return{success:this.tapEvents.length>=this.config.minRequiredTaps,hand:this.currentHand,tapCount:this.tapEvents.length,frequency:c,amplitude:h,rhythmVariability:l,amplitudeDecrement:f,duration:this.timeSignal[this.timeSignal.length-1]||0,tapEvents:this.tapEvents,rawData:{distanceSignal:this.distanceSignal,timeSignal:this.timeSignal,frameData:this.frameData}}}},{key:"_drawHandVisualization",value:function(t){var e=this,a=t[n],r=t[i];this.canvasCtx.strokeStyle="rgba(255, 255, 255, 0.5)",this.canvasCtx.lineWidth=2,this.canvasCtx.beginPath(),this.canvasCtx.moveTo(a.x*this.canvasElement.width,a.y*this.canvasElement.height),this.canvasCtx.lineTo(r.x*this.canvasElement.width,r.y*this.canvasElement.height),this.canvasCtx.stroke(),[a,r].forEach(function(t){e.canvasCtx.fillStyle="#ffffff",e.canvasCtx.beginPath(),e.canvasCtx.arc(t.x*e.canvasElement.width,t.y*e.canvasElement.height,10,0,2*Math.PI),e.canvasCtx.fill()})}},{key:"_resetTrialData",value:function(){this.distanceSignal=[],this.timeSignal=[],this.smoothedSignal=[],this.velocitySignal=[],this.tapEvents=[],this.frameData=[],this.startTime=null}}],s&&f(r.prototype,s),c&&f(r,c),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,s,c,l,d,m,v}();return r},"object"===v(e)?t.exports=r():void 0===(a="function"==typeof(i=r)?i.call(e,n,e,t):i)||(t.exports=a)}},e={},function n(i){var a=e[i];if(void 0!==a)return a.exports;var r=e[i]={exports:{}};return t[i].call(r.exports,r,r.exports,n),r.exports}(805).default;var t,e});